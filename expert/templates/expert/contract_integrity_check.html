{% extends "expert/base.html" %}
{% load static %}

{% block title %}계약 위변조 검증 - SatoShop Expert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'expert/css/contract_integrity_check.css' %}">
{% endblock %}

{% block extra_js %}
<script>
    window.integrityDocuments = {{ documents_meta_json|safe }};
    window.integritySelectedSlug = "{{ selected_document_slug|default:'' }}";
</script>
<script src="{% static 'expert/js/contract_integrity_check.js' %}" defer></script>
{% endblock %}

{% block content %}
<section class="section contract-integrity-section">
    <div class="container">
        <div class="integrity-hero">
            <h1 class="title is-3">계약 위변조 검증</h1>
            <p class="subtitle is-6">업로드한 최종 계약서 PDF가 시스템에 저장된 해시와 일치하는지 확인하세요.</p>
            {% if pdf_signing_enabled %}
                <p class="has-text-success is-size-7">디지털 인증서 서명이 활성화되어 있어 Adobe/PDF 뷰어에서도 변조 여부를 확인할 수 있습니다.</p>
            {% else %}
                <p class="has-text-grey is-size-7">디지털 서명이 아직 비활성화되어 있습니다. 인증서를 설정하면 PDF 자체에서도 서명 일치 여부를 확인할 수 있습니다.</p>
            {% endif %}
        </div>

        {% if empty_message %}
            <div class="integrity-card">
                <p>{{ empty_message }}</p>
                <p class="has-text-grey is-size-7">계약을 생성하거나 서명 완료하면 이 도구를 사용할 수 있습니다.</p>
            </div>
        {% else %}
            <div class="integrity-card" data-integrity-card>
                <form method="post" enctype="multipart/form-data" class="integrity-form" data-integrity-form>
                    {% csrf_token %}
                    <div class="field">
                        <label class="label">검증할 계약</label>
                        <div class="control">
                            {{ form.document_slug }}
                        </div>
                        {% if form.document_slug.errors %}
                            <p class="help is-danger">{{ form.document_slug.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div class="field">
                        <label class="label">검증 대상 PDF</label>
                        <div class="file has-name is-fullwidth" data-file-input-wrapper>
                            <label class="file-label">
                                {{ form.pdf_file }}
                                <span class="file-cta">
                                    <span class="file-icon"><i data-feather="upload"></i></span>
                                    <span class="file-label">PDF 선택</span>
                                </span>
                                <span class="file-name" data-file-name>선택된 파일이 없습니다</span>
                            </label>
                        </div>
                        {% if form.pdf_file.errors %}
                            <p class="help is-danger">{{ form.pdf_file.errors.0 }}</p>
                        {% else %}
                            <p class="help">{{ form.pdf_file.help_text }}</p>
                        {% endif %}
                    </div>
                    <div class="field is-grouped is-grouped-right">
                        <div class="control">
                            <button type="submit" class="button is-primary">검증 실행</button>
                        </div>
                    </div>
                </form>

                {% if selected_document %}
                    <div class="integrity-summary" data-integrity-summary>
                        <h4>선택한 계약 정보</h4>
                        <dl>
                            <div>
                                <dt>제목</dt>
                                <dd data-summary-title>{{ selected_document.payload.title|default:selected_document.slug }}</dd>
                            </div>
                            <div>
                                <dt>상태</dt>
                                <dd data-summary-status>{{ selected_document.get_status_display }}</dd>
                            </div>
                            <div>
                                <dt>생성일</dt>
                                <dd data-summary-created>{{ selected_document.created_at|date:"Y-m-d H:i" }}</dd>
                            </div>
                            <div>
                                <dt>저장된 해시</dt>
                                <dd><code data-summary-hash>{{ selected_document.final_pdf_hash|default:"(없음)" }}</code></dd>
                            </div>
                            <div>
                                <dt>최종 PDF</dt>
                                <dd data-summary-link>
                                    {% if selected_document.final_pdf %}
                                        <a href="{{ selected_document.final_pdf.url }}" target="_blank" rel="noopener">다운로드</a>
                                    {% else %}
                                        -
                                    {% endif %}
                                </dd>
                            </div>
                        </dl>
                    </div>
                {% else %}
                    <div class="integrity-summary" data-integrity-summary hidden>
                        <h4>선택한 계약 정보</h4>
                        <p class="has-text-grey is-size-7">계약을 선택하면 세부 정보가 표시됩니다.</p>
                    </div>
                {% endif %}

                {% if result %}
                    <div class="integrity-result integrity-result--{{ result.status }}">
                        <p class="integrity-result__title">{{ result.document.payload.title|default:result.document.slug }}</p>
                        <p class="integrity-result__message">{{ result.message }}</p>
                        <dl class="integrity-hash-list">
                            <div>
                                <dt>저장된 해시</dt>
                                <dd><code>{{ result.stored_hash|default:"(없음)" }}</code></dd>
                            </div>
                            <div>
                                <dt>업로드한 해시</dt>
                                <dd><code>{{ result.uploaded_hash }}</code></dd>
                            </div>
                        </dl>
                    </div>
                {% endif %}
            </div>

            <div class="integrity-card integrity-card--tips">
                <h2 class="title is-6">검증 방법</h2>
                <ol>
                    <li>위 계약 드롭다운에서 검증할 계약을 선택합니다.</li>
                    <li>상대방이 전달한 PDF 또는 저장해둔 최종본을 업로드합니다.</li>
                    <li>저장된 해시와 업로드한 해시가 일치하면 위변조가 없는 상태입니다.</li>
                </ol>
                <p class="is-size-7 has-text-grey">계약서가 다시 생성되거나 서명 정보가 변경된 경우 해시가 갱신됩니다.</p>
            </div>
        {% endif %}
    </div>
</section>
{% endblock %}
