{% extends "expert/base.html" %}
{% load static tz %}

{% block title %}계약 초안 작성 - SatoShop Expert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/easymde.min.css' %}">
<link rel="stylesheet" href="{% static 'expert/css/contract_draft.css' %}">
{% endblock %}

{% block content %}
<section class="section contract-draft-section">
    <div class="container">
        <div class="columns is-variable is-5">
            <div class="column is-7">
                <h1 class="title is-3 has-text-weight-bold">계약 조건 입력</h1>
                <p class="subtitle is-6 has-text-grey">
                    계약 조건을 입력하고, 계약서를 미리보기로 확인하세요. 입력을 마치면 자필 서명 후 상대방에게 링크를 공유해 동의를 요청할 수 있습니다.
                </p>
            </div>
            <div class="column is-5">
                <div class="status-box">
                    <p class="title is-6 mb-2">현재 단계</p>
                    <ol class="status-steps">
                        <li class="is-active">1. 계약 조건 입력</li>
                        <li>2. 서명 &amp; 검증</li>
                        <li>3. 라이트닝 정산</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="columns is-variable is-5 draft-layout">
            <div class="column is-7">
                <form method="post" novalidate>
                    {% csrf_token %}
                    {{ form.enable_chat }}
                    {% if form.non_field_errors %}
                        <div class="notification is-warning">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="field">
                        {{ form.title.label_tag }}
                        <div class="control">{{ form.title }}</div>
                        {% for error in form.title.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field">
                        <label class="label">나의 역할</label>
                        <div class="control role-select-group">
                            <div class="role-option-list">
                                {% for radio in form.role %}
                                    <label class="role-option">
                                        {{ radio.tag }}
                                        <span class="role-option-title">{{ radio.choice_label }}</span>
                                    </label>
                                {% endfor %}
                                <div class="role-option role-option--disabled" aria-disabled="true">
                                    <span class="role-option-title">중개자</span>
                                    <span class="role-option-caption">시스템(고정)</span>
                                </div>
                            </div>
                        </div>
                        {% for error in form.role.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field role-contact-fieldset" id="role-contact-fieldset" hidden>
                        <div class="role-contact-grid">
                            <div class="role-contact-card" id="performer-lightning-card" hidden>
                                <span class="label">수행자 정산 정보</span>
                                <p class="help">수행자로 계약을 진행할 경우 라이트닝 주소를 반드시 입력하세요.</p>
                                <div class="control mt-3">
                                    {{ form.performer_lightning_address.label_tag }}
                                    {{ form.performer_lightning_address }}
                                </div>
                                <p class="help">
                                    라이트닝 주소(필수)를 입력하지 않으면 계약을 진행할 수 없습니다.
                                </p>
                                {% for error in form.performer_lightning_address.errors %}
                                    <p class="help is-danger">{{ error }}</p>
                                {% endfor %}
                            </div>
                            <div class="role-contact-card role-contact-card--email">
                                <span class="label">이메일 안내</span>
                                <div id="role-email-field">
                                    {{ form.email_recipient.label_tag }}
                                    <div class="control">{{ form.email_recipient }}</div>
                                </div>
                                <p class="help" data-role-email-help="client">
                                    선택 사항입니다. 입력하면 계약 확정 후 계약서 PDF를 이메일로 받아볼 수 있어요.
                                </p>
                                <p class="help" data-role-email-help="performer" hidden>
                                    일반 이메일 주소를 입력하면 계약 완료 후 계약서 PDF를 발송해 드립니다.
                                </p>
                                {% for error in form.email_recipient.errors %}
                                    <p class="help is-danger">{{ error }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="field is-grouped">
                        <div class="control is-expanded">
                            {{ form.start_date.label_tag }}
                            {{ form.start_date }}
                            {% for error in form.start_date.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                        <div class="control is-expanded">
                            {{ form.end_date.label_tag }}
                            {{ form.end_date }}
                            {% for error in form.end_date.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="field">
                        {{ form.amount_sats.label_tag }}
                        <div class="control">{{ form.amount_sats }}</div>
                        <p class="help">총 계약 금액은 사토시 단위로 입력하세요.</p>
                        {% for error in form.amount_sats.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field">
                        <label class="label">지불 조건</label>
                        <div class="control option-pill-group">
                            <div class="option-pill-list option-pill-list--two">
                                {% for radio in form.payment_type %}
                                    <label class="option-pill">
                                        {{ radio.tag }}
                                        <span class="option-pill-title">{{ radio.choice_label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% for error in form.payment_type.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field milestone-section" id="milestone-section" hidden>
                        <div class="milestone-header">
                            <span class="label mb-0">분할 지급 구성</span>
                            <button type="button" class="button is-small add-milestone-button" id="add-milestone">
                                + 분할 추가
                            </button>
                        </div>
                        <p class="help milestone-hint">
                            각 단계마다 지급 금액(사토시), 지급 예정일, 지급 조건을 입력하세요. 지급일을 비워두면 "미정"으로 표기됩니다.
                        </p>
                        <div class="milestone-list" id="milestone-list" aria-live="polite"></div>
                        <div class="milestone-summary">
                            <p class="milestone-remaining" id="milestone-remaining">남은 금액: -</p>
                            <p class="milestone-error" id="milestone-error" role="alert" hidden>총 계약 금액을 초과할 수 없습니다.</p>
                        </div>
                    </div>

                    <div class="field payment-meta" id="one-time-section" hidden>
                        <div class="milestone-header">
                            <span class="label mb-0">일괄 지급 세부 정보</span>
                        </div>
                        <div class="columns is-variable is-2">
                            <div class="column">
                                {{ form.one_time_due_date.label_tag }}
                                {{ form.one_time_due_date }}
                            </div>
                            <div class="column">
                                {{ form.one_time_condition.label_tag }}
                                {{ form.one_time_condition }}
                            </div>
                        </div>
                        <p class="help">일괄 지급이라도 지급일과 조건을 명시해 주세요.</p>
                    </div>

                    <div class="field worklog-field">
                        {{ form.work_log_markdown.label_tag }}
                        <div class="control worklog-editor-wrapper">
                            {{ form.work_log_markdown }}
                        </div>
                        <p class="help">최대 10,000자까지 작성할 수 있으며 마크다운 포맷을 지원합니다.</p>
                        {% for error in form.work_log_markdown.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field attachment-field">
                        <label class="label">계약 관련 PDF 첨부</label>
                        {{ form.attachment_manifest }}
                        <div class="attachment-dropzone-wrapper"
                             id="contract-attachment-uploader"
                             data-upload-url="{% url 'expert:contract-attachment-upload' %}"
                             data-max-items="3"
                             data-max-size="5242880">
                            <div class="attachment-dropzone" id="contract-attachment-dropzone">
                                <div class="attachment-dropzone-content">
                                    <div class="dropzone-visual">
                                        <span class="dropzone-icon" aria-hidden="true">⇪</span>
                                    </div>
                                    <div class="dropzone-copy">
                                        <p class="dropzone-title">계약서에 첨부할 PDF 파일을 업로드하세요.</p>
                                        <p class="dropzone-caption">오직 PDF 포맷만 가능, 최대 3개, 개당 5MB 가능</p>
                                    </div>
                                    <button type="button" class="button is-small is-link is-light" id="contract-attachment-trigger">
                                        파일 선택
                                    </button>
                                </div>
                                <input type="file" id="contract-attachment-input" class="is-hidden" accept="application/pdf">
                            </div>
                            <div class="attachment-status" id="contract-attachment-status" role="status" aria-live="polite"></div>
                        </div>
                        <ul class="attachment-list" id="contract-attachment-list"></ul>
                    </div>

                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_privacy }} {{ form.agree_privacy.label }}
                        </label>
                        {% for error in form.agree_privacy.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_confidentiality }} {{ form.agree_confidentiality.label }}
                        </label>
                        {% for error in form.agree_confidentiality.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_intermediary }} {{ form.agree_intermediary.label }}
                        </label>
                        {% for error in form.agree_intermediary.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field mt-5">
                        <button type="submit" class="button is-primary is-medium is-fullwidth">
                            계약서 주소 생성
                        </button>
                    </div>
                </form>
            </div>
            <div class="column is-5">
                <div class="preview-card">
                    <div class="preview-header">
                        <h2 class="title is-5 mb-1">계약 미리보기</h2>
                        <p class="is-size-7 has-text-grey">입력 중인 계약 조건을 요약해서 보여줍니다.</p>
                    </div>
                    <div class="preview-body" id="contract-preview">
                        <ul class="spec-list">
                            <li><span>제목</span><strong id="preview-title">-</strong></li>
                            <li><span>역할</span><strong id="preview-role">-</strong></li>
                            <li><span>기간</span><strong id="preview-period">-</strong></li>
                            <li><span>금액</span><strong id="preview-amount">-</strong></li>
                            <li><span>지불 조건</span><strong id="preview-payment">-</strong></li>
                            <li><span>이메일</span><strong id="preview-email">-</strong></li>
                            <li><span>수행자 라이트닝</span><strong id="preview-performer-lightning">-</strong></li>
                        </ul>
                        <div class="preview-subsection" id="preview-milestone-panel" hidden>
                            <p class="preview-subsection-title">분할 지급 상세</p>
                            <ul class="milestone-preview-list" id="preview-milestone-list"></ul>
                        </div>
                        <div class="preview-subsection" id="preview-one-time-panel" hidden>
                            <p class="preview-subsection-title">일괄 지급 상세</p>
                            <ul class="one-time-preview-list">
                                <li><span>지급일</span><strong id="preview-one-time-date">-</strong></li>
                                <li><span>지급 조건</span><strong id="preview-one-time-condition">-</strong></li>
                            </ul>
                        </div>
                        <div class="preview-subsection">
                            <p class="preview-subsection-title">수행 내역 메모</p>
                            <div class="preview-worklog markdown-content" id="preview-worklog" data-empty="true">
                                <p class="preview-placeholder">작성된 메모가 없습니다.</p>
                            </div>
                        </div>
                        <div class="preview-subsection" id="preview-attachments" hidden>
                            <p class="preview-subsection-title">첨부 PDF</p>
                            <ul class="attachment-preview-list" id="preview-attachment-list"></ul>
                        </div>
                        <p class="preview-note">
                            계약 내용 아래에 계약 일반 사항이 붙어 계약서가 완성됩니다.
                        </p>
                    </div>
                    <div class="preview-footer">
                        {% if active_contract_template %}
                            <p class="preview-footnote">
                                현재 노출 계약서: <strong>{{ active_contract_template.title }}</strong>
                                <span class="preview-version">({{ active_contract_template.version_label }})</span>
                            </p>
                            <button type="button"
                                    class="button is-link is-light is-fullwidth preview-button"
                                    id="contract-preview-trigger"
                                    data-template-source="active-contract-template">
                                계약서 미리보기
                            </button>
                        {% else %}
                            <p class="preview-warning" role="alert">
                                시스템 표준 거래 계약서 미등록으로 계약서를 미리보기 할 수 없습니다.
                            </p>
                        {% endif %}
                    </div>
                </div>
                {% if contract_template_payload %}
                    {{ contract_template_payload|json_script:"active-contract-template" }}
                {% endif %}
            </div>
        </div>
    </div>
    {% if active_contract_template %}
    <div class="modal contract-preview-modal" id="contract-preview-modal" aria-hidden="true">
        <div class="modal-background" data-close-contract-modal></div>
        <div class="modal-card contract-modal-card" role="dialog" aria-modal="true" aria-labelledby="contract-preview-modal-title">
            <header class="modal-card-head">
                <div class="modal-card-heading">
                    <p class="modal-card-title" id="contract-preview-modal-title">계약서 미리보기</p>
                    <h1 class="modal-card-subtitle">개인과 개인 사이의 신의성실 기반 거래 계약서</h1>
                </div>
                <button class="delete" type="button" aria-label="닫기" data-close-contract-modal></button>
            </header>
            <section class="modal-card-body">
                <div class="modal-preview-stack">
                    <article class="preview-block preview-block--intro">
                        <h3 class="preview-block-title">1. 계약서 서문</h3>
                        <blockquote>
                            <strong>주의</strong>: 이 계약서는 정부나 공공기관의 강제력이 아닌, 당사자 간 신의성실의 원칙에 따라 체결하는 사적 거래 계약서 예시입니다. 실제 적용 시에는 반드시 계약 당사자의 상황에 맞게 조정하고 필요한 경우 전문가의 자문을 받으십시오.
                        </blockquote>
                    </article>
                    <article class="preview-block preview-block--draft">
                        <h3 class="preview-block-title">2. 계약 내용 (드래프트 입력)</h3>
                        <ul class="spec-list modal-spec-list">
                            <li><span>제목</span><strong id="modal-preview-title">-</strong></li>
                            <li><span>역할</span><strong id="modal-preview-role">-</strong></li>
                            <li><span>기간</span><strong id="modal-preview-period">-</strong></li>
                            <li><span>금액</span><strong id="modal-preview-amount">-</strong></li>
                            <li><span>지불 조건</span><strong id="modal-preview-payment">-</strong></li>
                            <li><span>계약서 이메일</span><strong id="modal-preview-email">-</strong></li>
                            <li><span>의뢰자 라이트닝</span><strong id="modal-preview-client-lightning">-</strong></li>
                            <li><span>수행자 라이트닝</span><strong id="modal-preview-performer-lightning">-</strong></li>
                        </ul>
                        <div class="preview-subsection modal-payment-section" id="modal-preview-milestones" hidden>
                            <div class="modal-payment-header">
                                <span class="modal-payment-pill" aria-hidden="true">분할 지급</span>
                                <p class="modal-payment-caption">단계별 지급 내역을 명확히 확인하세요.</p>
                            </div>
                            <ul class="milestone-preview-list modal-payment-list" id="modal-preview-milestone-list"></ul>
                        </div>
                        <div class="preview-subsection modal-payment-section" id="modal-preview-one-time" hidden>
                            <div class="modal-payment-header">
                                <span class="modal-payment-pill" aria-hidden="true">일괄 지급</span>
                                <p class="modal-payment-caption">정해진 시점에 한 번에 지급됩니다.</p>
                            </div>
                            <ul class="one-time-preview-list modal-payment-list">
                                <li><span>지급일</span><strong id="modal-preview-one-time-date">-</strong></li>
                                <li><span>지급 조건</span><strong id="modal-preview-one-time-condition">-</strong></li>
                            </ul>
                        </div>
                        <div class="preview-subsection">
                            <p class="preview-subsection-title">수행 내역 메모</p>
                            <div class="preview-worklog markdown-content" id="modal-preview-worklog" data-empty="true">
                                <p class="preview-placeholder">작성된 메모가 없습니다.</p>
                            </div>
                        </div>
                        <div class="preview-subsection" id="modal-preview-attachments" hidden>
                            <p class="preview-subsection-title">첨부 PDF</p>
                            <ul class="attachment-preview-list" id="modal-preview-attachment-list"></ul>
                        </div>
                        <p class="modal-hint">입력 중인 수행 내역, 첨부 파일, 단계별 금액은 계약 최종 확정 시 이 영역과 병합됩니다.</p>
                    </article>
                    <article class="preview-block preview-block--template">
                        <h3 class="preview-block-title">3. 계약 일반 사항</h3>
                        <div class="modal-template">
                            <div class="modal-template-body markdown-content" id="modal-template-markdown">
                                {% if active_contract_template_html %}
                                    {{ active_contract_template_html|safe }}
                                {% else %}
                                    <p class="modal-hint">계약서 본문이 비어 있습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                        <p class="modal-hint">
                            본 계약서는
                            <time datetime="{{ contract_generated_at|localtime|date:'c' }}">
                                {{ contract_generated_at|localtime|date:"Y-m-d H:i:s" }}
                            </time>
                            에 사토샵 Expert 시스템을 통해 생성되었으며, 당사자는 신의성실 원칙에 따라 모든 내용을 준수할 것을 확인한다.
                        </p>
                    </article>
                    <article class="preview-block preview-block--hash">
                        <h3 class="preview-block-title">4. 서명 해시 정보</h3>
                        <ul class="hash-list">
                            <li><span>의뢰자 서명 해시</span><strong class="hash-placeholder">생성 예정</strong></li>
                            <li><span>수행자 서명 해시</span><strong class="hash-placeholder">생성 예정</strong></li>
                            <li><span>사토샵 서명 해시</span><strong class="hash-placeholder">생성 예정</strong></li>
                        </ul>
                        <div class="hash-steps">
                            <p class="hash-steps-title">해시 계산 방법</p>
                            <ol>
                                <li><strong>의뢰자</strong>: 작성한 계약 내용 전체 + 계약 진행 버튼 클릭 시 타임스탬프(연/월/일/시/초) + 브라우저 정보 + 난수 Salt를 JSON으로 합쳐 SHA-256 해시.</li>
                                <li><strong>수행자</strong>: 의뢰자 해시 + 수행자 확인 타임스탬프 + 브라우저 정보 + 난수 Salt를 묶어 SHA-256 해시.</li>
                                <li><strong>사토샵</strong>: 수행자 해시 + 최종 계약서 PDF 생성 시 타임스탬프 + 난수 Salt를 입력해 SHA-256 해시.</li>
                            </ol>
                            <p class="hash-note">각 해시는 계약 확정 단계에서 자동 생성되며, 위 로그 값이 모두 확정되어야 계약이 완료됩니다.</p>
                        </div>
                    </article>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="button" class="button is-dark is-outlined" data-close-contract-modal>닫기</button>
            </footer>
        </div>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
{% if active_contract_template %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="{% static 'js/markdown-renderer.js' %}"></script>
{% endif %}
<script src="{% static 'js/easymde.min.js' %}"></script>
<script src="{% static 'expert/js/contract_draft.js' %}"></script>
{% endblock %}
