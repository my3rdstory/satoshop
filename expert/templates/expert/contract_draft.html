{% extends "expert/base.html" %}
{% load static %}

{% block title %}계약 초안 작성 - SatoShop Expert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/easymde.min.css' %}">
<link rel="stylesheet" href="{% static 'expert/css/contract_draft.css' %}">
{% endblock %}

{% block content %}
<section class="section contract-draft-section">
    <div class="container">
        <div class="columns is-variable is-5">
            <div class="column is-7">
                <h1 class="title is-3 has-text-weight-bold">계약 조건 입력</h1>
                <p class="subtitle is-6 has-text-grey">
                    계약 내용은 상대방과 시스템에서만 확인할 수 있도록 해시 기반으로 보관됩니다. 입력을 마친 뒤
                    상대방에게 링크를 공유해 동의를 요청하세요.
                </p>
            </div>
            <div class="column is-5">
                <div class="status-box">
                    <p class="title is-6 mb-2">현재 단계</p>
                    <ol class="status-steps">
                        <li class="is-active">1. 계약 조건 입력</li>
                        <li>2. 서명 &amp; 검증</li>
                        <li>3. 라이트닝 정산</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="columns is-variable is-5 draft-layout">
            <div class="column is-7">
                <form method="post" novalidate>
                    {% csrf_token %}
                    {{ form.enable_chat }}
                    {% if form.non_field_errors %}
                        <div class="notification is-warning">
                            {% for error in form.non_field_errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="field">
                        {{ form.title.label_tag }}
                        <div class="control">{{ form.title }}</div>
                        {% for error in form.title.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field">
                        <label class="label">나의 역할</label>
                        <div class="control role-select-group">
                            <div class="role-option-list">
                                {% for radio in form.role %}
                                    <label class="role-option">
                                        {{ radio.tag }}
                                        <span class="role-option-title">{{ radio.choice_label }}</span>
                                    </label>
                                {% endfor %}
                                <div class="role-option role-option--disabled" aria-disabled="true">
                                    <span class="role-option-title">중계자</span>
                                    <span class="role-option-caption">시스템(고정)</span>
                                </div>
                            </div>
                        </div>
                        {% for error in form.role.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field is-grouped">
                        <div class="control is-expanded">
                            {{ form.start_date.label_tag }}
                            {{ form.start_date }}
                            {% for error in form.start_date.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                        <div class="control is-expanded">
                            {{ form.end_date.label_tag }}
                            {{ form.end_date }}
                            {% for error in form.end_date.errors %}
                                <p class="help is-danger">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="field">
                        {{ form.amount_sats.label_tag }}
                        <div class="control">{{ form.amount_sats }}</div>
                        <p class="help">총 계약 금액은 사토시 단위로 입력하세요.</p>
                        {% for error in form.amount_sats.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field">
                        <label class="label">지불 조건</label>
                        <div class="control option-pill-group">
                            <div class="option-pill-list option-pill-list--two">
                                {% for radio in form.payment_type %}
                                    <label class="option-pill">
                                        {{ radio.tag }}
                                        <span class="option-pill-title">{{ radio.choice_label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% for error in form.payment_type.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field milestone-section" id="milestone-section" hidden>
                        <div class="milestone-header">
                            <span class="label mb-0">분할 지급 구성</span>
                            <button type="button" class="button is-small add-milestone-button" id="add-milestone">
                                + 분할 추가
                            </button>
                        </div>
                        <p class="help milestone-hint">총 계약 금액 안에서 각 분할 금액을 지정해 주세요. 기본으로 두 단계가 제공됩니다.</p>
                        <div class="milestone-list" id="milestone-list" aria-live="polite"></div>
                        <div class="milestone-summary">
                            <p class="milestone-remaining" id="milestone-remaining">남은 금액: -</p>
                            <p class="milestone-error" id="milestone-error" role="alert" hidden>총 계약 금액을 초과할 수 없습니다.</p>
                        </div>
                    </div>

                    <div class="field">
                        {{ form.email_recipient.label_tag }}
                        <div class="control">{{ form.email_recipient }}</div>
                        <p class="help">최종 계약서 PDF를 받을 이메일 주소를 입력하세요 (선택).</p>
                        {% for error in form.email_recipient.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field worklog-field">
                        {{ form.work_log_markdown.label_tag }}
                        <div class="control worklog-editor-wrapper">
                            {{ form.work_log_markdown }}
                        </div>
                        <p class="help">최대 10,000자까지 작성할 수 있으며 마크다운 포맷을 지원합니다.</p>
                        {% for error in form.work_log_markdown.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field attachment-field">
                        <label class="label">계약 관련 PDF 첨부</label>
                        {{ form.attachment_manifest }}
                        <div class="attachment-dropzone-wrapper"
                             id="contract-attachment-uploader"
                             data-upload-url="{% url 'expert:contract-attachment-upload' %}"
                             data-max-items="3"
                             data-max-size="5242880">
                            <div class="attachment-dropzone" id="contract-attachment-dropzone">
                                <div class="attachment-dropzone-content">
                                    <div class="dropzone-visual">
                                        <span class="dropzone-icon" aria-hidden="true">⇪</span>
                                    </div>
                                    <div class="dropzone-copy">
                                        <p class="dropzone-title">계약서에 첨부할 PDF 파일을 업로드하세요.</p>
                                        <p class="dropzone-caption">오직 PDF 포맷만 가능, 최대 3개, 개당 5MB 가능</p>
                                    </div>
                                    <button type="button" class="button is-small is-link is-light" id="contract-attachment-trigger">
                                        파일 선택
                                    </button>
                                </div>
                                <input type="file" id="contract-attachment-input" class="is-hidden" accept="application/pdf">
                            </div>
                            <div class="attachment-status" id="contract-attachment-status" role="status" aria-live="polite"></div>
                        </div>
                        <ul class="attachment-list" id="contract-attachment-list"></ul>
                    </div>

                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_privacy }} {{ form.agree_privacy.label }}
                        </label>
                        {% for error in form.agree_privacy.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_confidentiality }} {{ form.agree_confidentiality.label }}
                        </label>
                        {% for error in form.agree_confidentiality.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>
                    <div class="field agreement-field">
                        <label class="checkbox">
                            {{ form.agree_intermediary }} {{ form.agree_intermediary.label }}
                        </label>
                        {% for error in form.agree_intermediary.errors %}
                            <p class="help is-danger">{{ error }}</p>
                        {% endfor %}
                    </div>

                    <div class="field mt-5">
                        <button type="submit" class="button is-primary is-medium is-fullwidth">
                            입력값 검토 (준비 중)
                        </button>
                    </div>
                </form>
            </div>
            <div class="column is-5">
                <div class="preview-card">
                    <div class="preview-header">
                        <h2 class="title is-5 mb-1">계약 미리보기</h2>
                        <p class="is-size-7 has-text-grey">입력 중인 계약 조건을 요약해서 보여줍니다.</p>
                    </div>
                    <div class="preview-body" id="contract-preview">
                        <ul class="spec-list">
                            <li><span>제목</span><strong id="preview-title">-</strong></li>
                            <li><span>역할</span><strong id="preview-role">-</strong></li>
                            <li><span>기간</span><strong id="preview-period">-</strong></li>
                            <li><span>금액</span><strong id="preview-amount">-</strong></li>
                            <li><span>지불 조건</span><strong id="preview-payment">-</strong></li>
                            <li><span>이메일</span><strong id="preview-email">-</strong></li>
                        </ul>
                        <p class="preview-note">
                            계약 내용 아래에 계약 일반 사항이 붙어 계약서가 완성됩니다.
                        </p>
                    </div>
                    <div class="preview-footer">
                        {% if active_contract_template %}
                            <p class="preview-footnote">
                                현재 노출 계약서: <strong>{{ active_contract_template.title }}</strong>
                                <span class="preview-version">({{ active_contract_template.version_label }})</span>
                            </p>
                            <button type="button"
                                    class="button is-link is-light is-fullwidth preview-button"
                                    id="contract-preview-trigger"
                                    data-template-source="active-contract-template">
                                계약서 미리보기
                            </button>
                        {% else %}
                            <p class="preview-warning" role="alert">
                                시스템 표준 거래 계약서 미등록으로 계약서를 미리보기 할 수 없습니다.
                            </p>
                        {% endif %}
                    </div>
                </div>
                {% if contract_template_payload %}
                    {{ contract_template_payload|json_script:"active-contract-template" }}
                {% endif %}
            </div>
        </div>
    </div>
    {% if active_contract_template %}
    <div class="modal contract-preview-modal" id="contract-preview-modal" aria-hidden="true">
        <div class="modal-background" data-close-contract-modal></div>
        <div class="modal-card contract-modal-card" role="dialog" aria-modal="true" aria-labelledby="contract-preview-modal-title">
            <header class="modal-card-head">
                <p class="modal-card-title" id="contract-preview-modal-title">계약서 미리보기</p>
                <button class="delete" type="button" aria-label="닫기" data-close-contract-modal></button>
            </header>
            <section class="modal-card-body">
                <div class="modal-summary">
                    <h3 class="modal-summary-title">현재 입력한 계약 조건</h3>
                    <ul class="spec-list modal-spec-list">
                        <li><span>제목</span><strong id="modal-preview-title">-</strong></li>
                        <li><span>역할</span><strong id="modal-preview-role">-</strong></li>
                        <li><span>기간</span><strong id="modal-preview-period">-</strong></li>
                        <li><span>금액</span><strong id="modal-preview-amount">-</strong></li>
                        <li><span>지불 조건</span><strong id="modal-preview-payment">-</strong></li>
                        <li><span>이메일</span><strong id="modal-preview-email">-</strong></li>
                    </ul>
                </div>
                <div class="modal-template">
                    <div class="modal-template-meta">
                        <p class="template-title" id="modal-template-title"></p>
                        <p class="template-version" id="modal-template-version"></p>
                    </div>
                    <div class="modal-template-body markdown-content" id="modal-template-markdown"></div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button type="button" class="button is-dark is-outlined" data-close-contract-modal>닫기</button>
            </footer>
        </div>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block extra_js %}
{% if active_contract_template %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="{% static 'js/markdown-renderer.js' %}"></script>
{% endif %}
<script src="{% static 'js/easymde.min.js' %}"></script>
<script src="{% static 'expert/js/contract_draft.js' %}"></script>
{% endblock %}
