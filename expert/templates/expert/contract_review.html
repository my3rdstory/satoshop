{% extends "expert/base.html" %}
{% load static %}

{% block title %}계약 최종 검토 - SatoShop Expert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'expert/css/contract_flow.css' %}">
{% endblock %}

{% block content %}
<section class="section contract-flow-section">
    <div class="container">
        <div class="contract-flow-hero">
            <p class="subtitle is-6 has-text-grey-light">Step 2 · 계약 검토 &amp; 서명</p>
            <h1 class="title is-3">계약 내용을 모두 확인하고 자필 서명을 남겨주세요.</h1>
            <p class="has-text-grey-light">서명 후에는 계약서 전용 주소가 발급되어 상대방에게 공유할 수 있습니다.</p>
        </div>

        <div class="contract-flow-grid">
            <article class="contract-flow-card">
                <h3>계약 조건 요약</h3>
                <ul class="contract-flow-list">
                    <li><span>제목</span><strong>{{ draft_payload.title }}</strong></li>
                    <li><span>역할</span><strong>{{ draft_payload.role_display }}</strong></li>
                    <li><span>기간</span><strong>{{ draft_payload.start_date }} ~ {{ draft_payload.end_date|default:'미정' }}</strong></li>
                    <li><span>총 금액</span><strong>{{ draft_payload.amount_sats|default:'-' }} sats</strong></li>
                    <li><span>지급 방식</span><strong>{{ draft_payload.payment_display }}</strong></li>
                    <li><span>이메일</span><strong>{{ draft_payload.email_recipient|default:'미입력' }}</strong></li>
                </ul>
                {% if draft_payload.milestones %}
                <div class="hash-note mt-4">
                    <p class="has-text-weight-semibold">분할 지급</p>
                    <ul>
                        {% for milestone in draft_payload.milestones %}
                            <li>분할 {{ forloop.counter }}: {{ milestone }} sats</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </article>

            <article class="contract-flow-card">
                <h3>계약 일반 사항</h3>
                <div class="modal-template-body">
                    {% if draft_payload.contract_template.content_html %}
                        {{ draft_payload.contract_template.content_html|safe }}
                    {% else %}
                        <p class="has-text-grey">등록된 계약서 본문이 없습니다.</p>
                    {% endif %}
                </div>
            </article>

            <article class="contract-flow-card">
                <h3>첨부 &amp; 메모</h3>
                <p class="mb-2">수행 내역</p>
                <div class="hash-display">{{ draft_payload.work_log_markdown|default:'작성된 메모가 없습니다.' }}</div>
                <p class="mt-4 mb-2">첨부 파일</p>
                {% if draft_payload.attachments %}
                    <ul>
                        {% for attachment in draft_payload.attachments %}
                            <li>{{ attachment.name }} ({{ attachment.size|default:"-" }})</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="has-text-grey">첨부된 파일이 없습니다.</p>
                {% endif %}
            </article>
        </div>

        <form method="post" class="contract-flow-card">
            {% csrf_token %}
            <h3>자필 서명</h3>
            {{ form.signature_data }}
            <div class="signature-pad-wrapper">
                <canvas class="signature-canvas" data-signature-canvas></canvas>
                <div class="signature-actions">
                    <p class="has-text-grey-light">터치/마우스로 서명해 주세요.</p>
                    <button type="button" class="button is-small is-outlined" data-signature-clear>서명 지우기</button>
                </div>
            </div>
            <div class="signature-preview" data-signature-preview hidden>
                <p class="signature-preview-label">서명 미리보기</p>
                <img src="" alt="서명 미리보기" data-signature-preview-img>
            </div>
            <div class="field mt-4">
                <label class="checkbox">
                    {{ form.confirm_reviewed }} 계약 내용을 모두 확인했고, 자필 서명을 완료했습니다.
                </label>
                {% for error in form.confirm_reviewed.errors %}
                    <p class="help is-danger">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field mt-4">
                <button type="submit" class="button is-primary is-fullwidth is-medium"
                        data-signature-submit disabled>계약서 주소 생성</button>
            </div>
        </form>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
<script src="{% static 'expert/js/contract_signature.js' %}"></script>
{% endblock %}
