{% extends "expert/base.html" %}
{% load static humanize %}

{% block title %}직접 계약 생성 - SatoShop Expert{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'expert/css/direct_contract_start.css' %}">
{% endblock %}

{% block content %}
{% if hero_slides %}
<section class="expert-hero-carousel section" data-expert-hero-carousel>
    {% for slide in hero_slides %}
        <article id="expert-hero-slide-{{ forloop.counter0 }}" class="expert-hero-slide{% if forloop.first %} is-active{% endif %}" data-expert-hero-slide data-duration="{{ slide.rotation_seconds }}">
            <div class="expert-hero-bg" style="{{ slide.background_style }}">
                <span class="expert-hero-overlay" style="background: {{ slide.overlay_color|default:"rgba(2, 6, 23, 0.65)" }};"></span>
            </div>
            <div class="expert-hero-body">
                {{ slide.html|safe }}
            </div>
        </article>
    {% endfor %}

    {% if hero_slides|length > 1 %}
        <button class="expert-hero-nav expert-hero-nav-prev" type="button" data-expert-carousel-prev aria-label="이전 배너">
            <span aria-hidden="true">&#10094;</span>
        </button>
        <button class="expert-hero-nav expert-hero-nav-next" type="button" data-expert-carousel-next aria-label="다음 배너">
            <span aria-hidden="true">&#10095;</span>
        </button>
        <div class="expert-hero-indicators" role="tablist">
            {% for slide in hero_slides %}
                <button class="expert-hero-indicator{% if forloop.first %} is-active{% endif %}" type="button" data-expert-carousel-indicator="{{ forloop.counter0 }}" aria-label="{{ slide.name }}" aria-controls="expert-hero-slide-{{ forloop.counter0 }}"></button>
            {% endfor %}
        </div>
    {% endif %}
</section>
{% endif %}

<section class="section contract-feature-grid">
    <div class="container feature-grid">
        <article class="feature-card">
            <p class="feature-label">의뢰자 & 수행자</p>
            <h3>각자의 정산 정보로 안전하게</h3>
            <p>역할을 선택하면 필요한 정산 정보 입력 가이드가 즉시 노출되고, 최종 PDF에도 동일하게 반영됩니다.</p>
        </article>
        <article class="feature-card">
            <p class="feature-label">계정 인증</p>
            <h3>인증된 계정만 계약 참여</h3>
            <p>로그인한 인증 계정만 계약을 생성하고, 상대방도 링크 접속 시 동일한 인증을 거쳐 서명합니다.</p>
        </article>
        <article class="feature-card">
            <p class="feature-label">건당 수수료</p>
            <h3>고정 금액으로 투명하게</h3>
            <p>시스템은 분쟁에 개입하지 않으며 계약 금액과 무관하게 건당 고정 수수료만 받습니다. 의뢰자·수행자는 라이트닝 위젯에서 동일 금액을 확인하고 결제합니다.</p>
        </article>
        <article class="feature-card">
            <p class="feature-label">계약 보관함</p>
            <h3>모든 계약 PDF를 한눈에</h3>
            <p>생성하거나 서명한 계약은 위변조 검증 해시와 함께 계약 보관함에서 다시 내려받을 수 있습니다.</p>
        </article>
        <article class="feature-card">
            <p class="feature-label">위변조 검증</p>
            <h3>업로드 PDF와 해시 비교</h3>
            <p>저장된 해시와 외부 PDF의 SHA-256 값을 비교해 변조 여부를 즉시 검증할 수 있습니다.</p>
        </article>
    </div>
</section>

{% if usage_stats %}
<section class="section expert-stats">
    <div class="container">
        <div class="stats-header">
            <h2>Expert 현황</h2>
            <p>계약 진행과 참여 현황을 한눈에 확인하세요.</p>
        </div>
        <div class="stats-grid">
        <article class="stat-card">
            <p class="stat-label">누적 계약</p>
            <p class="stat-value">{{ usage_stats.contracts_total|intcomma }}건</p>
            <p class="stat-note">완료 {{ usage_stats.contracts_completed|intcomma }}건</p>
        </article>
        <article class="stat-card">
            <p class="stat-label">계약 금액 합계</p>
            <p class="stat-value">{{ usage_stats.contract_amount_sats|intcomma }} sats</p>
            <p class="stat-note">계약 본문에 입력된 총액</p>
        </article>
        <article class="stat-card">
            <p class="stat-label">참여자 합계</p>
            <p class="stat-value">{{ usage_stats.unique_creators|add:usage_stats.unique_counterparties|intcomma }}명</p>
            <p class="stat-note">생성자 {{ usage_stats.unique_creators|intcomma }} · 상대방 {{ usage_stats.unique_counterparties|intcomma }}</p>
        </article>
        <article class="stat-card">
            <p class="stat-label">라이트닝 인증 합계</p>
            <p class="stat-value">{{ usage_stats.expert_lightning_users_total|intcomma }}명</p>
            <p class="stat-note">
                최근 {{ usage_stats.payments.window_days }}일 인증 {{ usage_stats.expert_lightning_users_active|default:0|intcomma }}명
            </p>
        </article>
        {% with bsl_stats=usage_stats.payments.filtered_stats|default:usage_stats.payments %}
        <article class="stat-card stat-card--bsl">
            <p class="stat-label">BSL 후원 예정 금액</p>
            <p class="stat-value">{{ bsl_stats.total_amount_sats|default:0|intcomma }} sats</p>
            <p class="stat-note">이번 달 수수료 합계</p>
        </article>
        {% endwith %}
        </div>
    </div>
</section>
{% endif %}

<section class="section contract-inputs">
    <div class="container">
        <h2 class="title is-4">계약 입력 항목</h2>
        <p class="subtitle is-6 has-text-grey-light">모든 항목은 한 화면에서 작성되고 곧바로 서명 단계로 이어집니다.</p>
        <div class="input-grid">
            <div class="input-item"><span>역할 및 정산 정보</span></div>
            <div class="input-item"><span>계약 제목 · 본문 (일반 텍스트)</span></div>
            <div class="input-item"><span>수행 기간 (시작/종료일)</span></div>
            <div class="input-item"><span>총 계약 금액(사토시) & 지불 방식</span></div>
            <div class="input-item"><span>분할 지급 단계별 조건</span></div>
            <div class="input-item"><span>자필 서명 캡처 & 필수 동의</span></div>
        </div>
        <div class="payment-note">
            <strong>안내</strong>
            <p>의뢰자·수행자가 각자 지정된 사토시 금액을 결제한 뒤 계약 프로세스가 이어집니다.</p>
        </div>
    </div>
</section>

<section class="section next-step-section">
    <div class="container">
        <h2 class="title is-4">3단계 진행 흐름</h2>
        <ol class="step-preview">
            <li>
                <span class="badge">1</span>
                <div>
                    <p class="step-title">기본 정보 & 정산 입력</p>
                    <p class="step-desc">역할, 정산 주소, 계약 기간·금액을 입력하고 필요 시 계약 단계별 결제를 안내합니다.</p>
                </div>
            </li>
            <li>
                <span class="badge">2</span>
                <div>
                    <p class="step-title">본문 작성</p>
                    <p class="step-desc">마크다운 본문으로 주요 조건을 정리하면 입력 내용이 바로 저장되고 서명 흐름으로 전환됩니다.</p>
                </div>
            </li>
            <li>
                <span class="badge">3</span>
                <div>
                    <p class="step-title">서명 & 공유</p>
                    <p class="step-desc">동의 체크 후 자필 서명을 남기면 공유 링크가 발급되고, 상대방도 인증 절차를 거쳐 서명합니다.</p>
                </div>
            </li>
        </ol>
        <div class="action-box mt-5">
            <p class="title is-5 mb-3">지금 바로 계약 초안을 작성하세요</p>
            <p class="content">
                계정 로그인을 마쳤다면 즉시 초안을 작성하고, 필요 시 결제 정책을 반영해 상대방과 계약을 마무리할 수 있습니다.
            </p>
            <a class="button is-primary is-medium is-fullwidth" href="{% url 'expert:direct-draft' %}">
                계약 작성 화면으로 이동
            </a>
            <p class="is-size-7 has-text-grey mt-2">공유 링크는 계약 생성 직후 발급되며, 상대방 결제·서명도 같은 링크에서 처리됩니다.</p>
        </div>
    </div>
</section>
<a
    class="expert-contact-fab"
    href="https://discord.com/channels/1316677392517042237/1422089028618162394"
    target="_blank"
    rel="noopener noreferrer"
    aria-describedby="expert-contact-tooltip"
>
    <span class="expert-contact-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" role="img" focusable="false">
            <path d="M20.317 4.369a19.91 19.91 0 0 0-4.885-1.515c-.21.36-.45.846-.616 1.23a18.212 18.212 0 0 0-5.705 0 12.26 12.26 0 0 0-.617-1.23 19.83 19.83 0 0 0-4.89 1.516C1.984 8.048 1.18 11.6 1.495 15.103a19.99 19.99 0 0 0 6.09 3.082c.492-.674.93-1.39 1.31-2.14a12.66 12.66 0 0 1-2.07-.986c.173-.127.342-.26.506-.396 3.98 1.861 8.285 1.861 12.223 0 .165.137.334.27.506.397a12.7 12.7 0 0 1-2.074.991c.377.747.814 1.463 1.307 2.138a19.9 19.9 0 0 0 6.093-3.085c.25-2.653-.43-6.173-2.973-10.732ZM9.678 13.764c-1.194 0-2.177-1.096-2.177-2.445 0-1.35.955-2.452 2.18-2.452 1.224 0 2.198 1.102 2.177 2.452-.02 1.349-.953 2.445-2.18 2.445Zm4.669 0c-1.194 0-2.176-1.096-2.176-2.445 0-1.35.956-2.452 2.18-2.452 1.225 0 2.198 1.102 2.177 2.452-.02 1.349-.953 2.445-2.181 2.445Z"></path>
        </svg>
    </span>
    <span class="expert-contact-label">문의하기</span>
    <span class="expert-contact-tooltip" id="expert-contact-tooltip" role="tooltip">
        문의는 디스코드 사토샵 채널에서만 받습니다.
    </span>
</a>
{% endblock %}

{% block extra_js %}
<script src="{% static 'expert/js/direct_contract_start.js' %}"></script>
{% endblock %}
