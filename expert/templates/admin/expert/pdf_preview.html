{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<div class="module">
  <h1>Expert 계약서 PDF 검증</h1>
  <div class="submit-row" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:center;">
    {% if tool_enabled %}
      <div class="help">Expert 계약서 PDF 검증 도구가 활성화되었습니다.</div>
      <form method="post" style="margin:0;">
        {% csrf_token %}
        <input type="hidden" name="action" value="toggle">
        <input type="hidden" name="toggle_state" value="disable">
        <button type="submit" class="button" style="background:#334155; color:#f8fafc;">도구 비활성화</button>
      </form>
    {% else %}
      <div class="help">도구가 비활성화되어 있습니다. 아래 버튼을 눌러 활성화한 뒤 PDF를 검증할 수 있습니다.</div>
      <form method="post" style="margin:0;">
        {% csrf_token %}
        <input type="hidden" name="action" value="toggle">
        <input type="hidden" name="toggle_state" value="enable">
        <button type="submit" class="default">도구 활성화</button>
      </form>
    {% endif %}
  </div>

  {% if tool_enabled %}
    <p>Payload(JSON)과 계약 본문(Markdown)을 수정한 뒤 “PDF 다운로드” 버튼을 누르면 즉시 최종 PDF를 받아볼 수 있습니다.</p>
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="generate">
      <fieldset class="module aligned">
        {% for field in form %}
          <div class="form-row">
            {{ field.errors }}
            <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}<span class="required">*</span>{% endif %}</label>
            {{ field }}
            {% if field.help_text %}<p class="help">{{ field.help_text }}</p>{% endif %}
            {% if field.name == "payload_json" and payment_samples %}
              <div class="payload-sample-helper">
                <p class="help" style="margin-bottom:0.4rem;">지불 조건별 샘플 Payload</p>
                <ul class="payload-sample-list" style="list-style:none; margin:0 0 0.6rem; padding:0; display:flex; flex-direction:column; gap:0.35rem;">
                  {% for sample in payment_samples %}
                    <li style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                      <textarea class="payload-sample-data" data-sample-key="{{ sample.key }}" hidden>{{ sample.payload_json }}</textarea>
                      <button type="button"
                              class="button payload-sample-button"
                              data-payload-target="{{ field.id_for_label }}"
                              data-sample-key="{{ sample.key }}">
                        {{ sample.label }} 샘플
                      </button>
                      <span class="help" style="margin:0;">{{ sample.description }}</span>
                    </li>
                  {% endfor %}
                </ul>
                <p class="help">버튼을 누르면 Payload JSON이 해당 샘플로 교체되며, 수행 내역 텍스트는 동일하게 유지됩니다.</p>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </fieldset>
      <div class="submit-row">
        <button type="submit" class="default" name="action" value="generate">PDF 다운로드</button>
      </div>
    </form>

    <div class="module">
      <h2>템플릿 바로가기</h2>
      {% if template_shortcuts %}
        <ul>
          {% for template in template_shortcuts %}
            <li>
              <a href="?template={{ template.pk }}">{{ template }}</a>
              {% if template.is_selected %}<strong> (노출 중)</strong>{% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>등록된 계약 템플릿이 없습니다. 먼저 템플릿을 추가해 주세요.</p>
      {% endif %}
    </div>

    <div class="module">
      <h2>사용 팁</h2>
      <ul>
        <li>Payload JSON은 계약 개요/지급/워크로그에 사용되는 데이터입니다. 필요한 값만 수정해도 됩니다.</li>
        <li>템플릿 링크를 클릭해 페이지를 새로고침하면 해당 템플릿 본문이 기본값으로 채워집니다.</li>
        <li>인라인 폰트가 포함되므로 Render 네이티브 환경에서도 한글이 깨지지 않습니다.</li>
        <li>CLI에서 `uv run python scripts/render_sample_contract.py`를 실행하면 동일한 샘플 PDF를 생성할 수 있습니다.</li>
      </ul>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var sampleMap = {};
        document.querySelectorAll('.payload-sample-data').forEach(function (textarea) {
          var key = textarea.getAttribute('data-sample-key');
          if (key) {
            sampleMap[key] = textarea.value;
          }
        });
        document.querySelectorAll('.payload-sample-button').forEach(function (button) {
          button.addEventListener('click', function () {
            var targetId = button.getAttribute('data-payload-target');
            var sampleKey = button.getAttribute('data-sample-key');
            var payloadField = document.getElementById(targetId);
            if (!payloadField) {
              return;
            }
            var nextValue = sampleMap[sampleKey] || '';
            payloadField.value = nextValue;
            payloadField.focus();
            payloadField.scrollTop = 0;
          });
        });
      });
    </script>
  {% endif %}
</div>
{% endblock %}
