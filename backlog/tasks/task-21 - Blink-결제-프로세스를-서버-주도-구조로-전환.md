---
id: task-21
title: Blink 결제 프로세스를 서버 주도 구조로 전환
status: To Do
assignee: []
created_date: '2025-09-29 05:52'
updated_date: '2025-09-29 05:57'
labels: []
dependencies: []
---

## Description

<!-- SECTION:DESCRIPTION:BEGIN -->
Blink 인보이스 결제 완료 후 UI 지연이나 예기치 않은 오류로 인해 주문 레코드가 저장되지 않는 사고가 반복되고 있다. 결제 성공 여부를 서버가 주도적으로 판정하고, 결제-주문 저장을 분리하지 않는 구조로 개편해 누락을 근본적으로 차단해야 한다. 인보이스 생성부터 콜백 처리까지 idem 키를 일관되게 활용하고 트랜잭션으로 감싸 중복 호출에도 안전하게 유지한다.

검토 결과, 인보이스 생성 시점에 장바구니/배송 정보를 포함한 주문 스냅샷을 DB에 선 저장하고 Blink 호출과 동일 트랜잭션으로 묶어야 함이 확인되었다. 또한 Blink 웹훅(혹은 큐 기반 재시도)을 통한 서버 주도 확정을 위해 idempotent 키 관리, 콜백 서명 검증, 재고 예약 정책 정립이 선행되어야 한다. 프런트 폴링에 의존하던 주문 생성 로직을 분리해 서버 콜백이 독자적으로 주문을 완성하도록 구조 개편이 필요하다.
<!-- SECTION:DESCRIPTION:END -->

## Acceptance Criteria
<!-- AC:BEGIN -->
- [ ] #1 인보이스 생성 API가 주문 스켈레톤과 Blink 인보이스 정보를 하나의 트랜잭션으로 pending 상태에 저장하고, 저장이 실패하면 클라이언트에 인보이스를 반환하지 않는다.
- [ ] #2 Blink 콜백 또는 웹훅 처리기가 서명 검증 후 idem 키(예: 인보이스 ID)로 주문을 조회해 pending에서 paid로 승격하며, 동일 콜백이 반복되어도 중복 주문이 생성되지 않는다.
- [ ] #3 주문 상태와 영수증 저장이 모두 커밋되기 전에 Blink에 성공 응답을 보내지 않고 재시도 가능하도록 처리하여, 콜백 재전송만으로 주문-결제 싱크를 복구할 수 있다.
<!-- AC:END -->
