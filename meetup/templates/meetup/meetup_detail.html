{% extends 'stores/store_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ meetup.name }} - {{ store.store_name }}{% endblock %}

<!-- ë°‹ì—…ë³„ ì˜¤í”ˆê·¸ë˜í”„ ì„¤ì • -->
{% block og_title %}{{ meetup.name }} - {{ store.store_name }}{% endblock %}
{% block og_description %}{% if meetup.description %}{{ meetup.description|truncatewords:30 }}{% else %}{{ store.store_name }}ì—ì„œ ë¹„íŠ¸ì½”ì¸ìœ¼ë¡œ ì°¸ê°€í•˜ì„¸ìš” - {{ meetup.name }}{% endif %}{% endblock %}
{% block og_type %}event{% endblock %}
{% block og_image %}{% if meetup.images.exists %}{{ meetup.images.first.file_url }}{% elif store and store.images.exists %}{{ store.images.first.file_url }}{% elif site_settings and site_settings.og_default_image %}{{ site_settings.og_default_image }}{% else %}{% static 'images/satoshop-logo-1x1-favicon.png' %}{% endif %}{% endblock %}

{% block twitter_title %}{{ meetup.name }} - {{ store.store_name }}{% endblock %}
{% block twitter_description %}{% if meetup.description %}{{ meetup.description|truncatewords:30 }}{% else %}{{ store.store_name }}ì—ì„œ ë¹„íŠ¸ì½”ì¸ìœ¼ë¡œ ì°¸ê°€í•˜ì„¸ìš” - {{ meetup.name }}{% endif %}{% endblock %}
{% block twitter_image %}{% if meetup.images.exists %}{{ meetup.images.first.file_url }}{% elif store and store.images.exists %}{{ store.images.first.file_url }}{% elif site_settings and site_settings.og_default_image %}{{ site_settings.og_default_image }}{% else %}{% static 'images/satoshop-logo-1x1-favicon.png' %}{% endif %}{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'css/meetup_detail.css' %}">
<!-- Markdown Renderer CSS -->
<link rel="stylesheet" href="{% static 'css/markdown-renderer.css' %}">
<style>
.meetup-image-container {
    aspect-ratio: 1 / 1;
    background: linear-gradient(135deg, #faf5ff 0%, #e0e7ff 100%);
    border-radius: 12px;
    overflow: hidden;
}
.dark .meetup-image-container {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
}
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}

{% block store_content %}
{% csrf_token %}
<div class="bg-gray-50 dark:bg-gray-900 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- ì™¼ìª½: ë°‹ì—… ì´ë¯¸ì§€, ì†Œê°œ, ì£¼ìµœì ì—°ë½ì²˜ -->
      <div class="space-y-6">
        <!-- ë°‹ì—… ì´ë¯¸ì§€ -->
        <div class="space-y-4">
          <!-- ë©”ì¸ ì´ë¯¸ì§€ -->
          <div class="meetup-image-container relative">
            {% if meetup.images.exists %}
            <img id="mainImage" src="{{ meetup.images.first.file_url }}" alt="{{ meetup.name }}" 
                 class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full flex items-center justify-center">
              <div class="text-center text-purple-400 dark:text-purple-300">
                <i class="fas fa-users text-6xl mb-4"></i>
                <div class="text-lg">ì´ë¯¸ì§€ ì—†ìŒ</div>
              </div>
            </div>
            {% endif %}
            
            <!-- ì¡°ê¸°ë“±ë¡ í• ì¸ ì˜¤ë²„ë ˆì´ -->
            {% if meetup.is_discounted and meetup.is_early_bird_active %}
            <div class="absolute top-0 left-0 right-0 bg-black bg-opacity-70 text-white px-4 py-3">
              <div class="flex items-center justify-center gap-2">
                <i class="fas fa-bolt text-yellow-400"></i>
                <span class="text-lg font-bold">ì¡°ê¸°ë“±ë¡ {{ meetup.public_discount_rate }}% í• ì¸ ë°‹ì—…</span>
                <i class="fas fa-fire text-red-400"></i>
              </div>
              {% if meetup.early_bird_end_datetime %}
              <div class="text-center text-sm text-yellow-200 mt-1">
                <i class="fas fa-clock mr-1"></i>
                {{ meetup.early_bird_end_datetime|date:"mì›” dì¼ H:i" }}ê¹Œì§€ / <span id="early-bird-countdown-overlay">ê³„ì‚° ì¤‘...</span>
              </div>
              <script type="application/json" id="countdown-data">
              {
                "endDateTime": "{{ meetup.early_bird_end_datetime|date:'Y-m-d H:i:s' }}"
              }
              </script>
              {% endif %}
            </div>
            {% endif %}
          </div>
          
          <!-- ì¸ë„¤ì¼ ì´ë¯¸ì§€ -->
          {% if meetup.images.all|length > 1 %}
          <div class="grid grid-cols-4 gap-3">
            {% for image in meetup.images.all %}
            <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                 onclick="changeMainImage('{{ image.file_url }}', this)">
              <img src="{{ image.file_url }}" alt="{{ meetup.name }}" 
                   class="w-full h-full object-cover rounded cursor-pointer hover:opacity-80 transition-opacity">
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- ë°‹ì—… ì†Œê°œ -->
        {% if meetup.description %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-info-circle text-blue-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ë°‹ì—… ì†Œê°œ</h3>
          </div>
          <div class="prose max-w-none markdown-content text-gray-900 dark:text-white">
            {{ meetup.description }}
          </div>
        </div>
        {% endif %}

        <!-- ì£¼ìµœì ì •ë³´ -->
        {% if meetup.organizer_contact or meetup.organizer_email or meetup.organizer_chat_channel %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-user-tie text-purple-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì£¼ìµœì ì—°ë½ì²˜</h3>
          </div>
          <div class="space-y-3">
            {% if meetup.organizer_contact %}
            <div class="flex items-center gap-3">
              <i class="fas fa-phone text-gray-500 w-4"></i>
              <span class="text-gray-900 dark:text-white">{{ meetup.organizer_contact }}</span>
            </div>
            {% endif %}
            {% if meetup.organizer_email %}
            <div class="flex items-center gap-3">
              <i class="fas fa-envelope text-gray-500 w-4"></i>
              <a href="mailto:{{ meetup.organizer_email }}" 
                 class="text-blue-600 dark:text-blue-400 hover:underline">
                {{ meetup.organizer_email }}
              </a>
            </div>
            {% endif %}
            {% if meetup.organizer_chat_channel %}
            <div class="flex items-center gap-3">
              <i class="fas fa-comments text-gray-500 w-4"></i>
              <a href="{{ meetup.organizer_chat_channel }}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="text-blue-600 dark:text-blue-400 hover:underline">
                ì†Œí†µì±„ë„ ë°”ë¡œê°€ê¸°
                <i class="fas fa-external-link-alt text-xs ml-1"></i>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- ì˜¤ë¥¸ìª½: ê¸°ì¡´ ë°‹ì—… ì •ë³´ -->
      <div class="space-y-4">
        <!-- ì œëª© -->
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ meetup.name }}</h1>
          {% if not meetup.is_active %}
          <span class="inline-block px-3 py-1 bg-gray-500 text-white text-sm rounded-full">ë¹„í™œì„±í™”</span>
          {% endif %}
        </div>

        <!-- ì¼ì • ì •ë³´ -->
        {% if meetup.date_time %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-2">
            <i class="fas fa-calendar-alt text-purple-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì¼ì •</h3>
          </div>
          <div class="text-xl font-medium text-gray-900 dark:text-white">
            {{ meetup.date_time|date:"Yë…„ mì›” dì¼ (l)" }}
          </div>
          <div class="text-lg text-gray-600 dark:text-gray-400">
            {{ meetup.date_time|date:"H:i" }}
          </div>
        </div>
        {% endif %}

        <!-- ì¥ì†Œ ì •ë³´ -->
        {% if meetup.location_tbd or meetup.location_full_address or meetup.special_notes %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-map-marker-alt text-green-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì¥ì†Œ</h3>
            {% if meetup.location_full_address and not meetup.location_tbd %}
            <button onclick="openNaverMap('{{ meetup.location_full_address }}')" 
                    class="flex items-center gap-1 px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors shadow-sm hover:shadow-md"
                    title="ë„¤ì´ë²„ì§€ë„ì—ì„œ ë³´ê¸°">
              <i class="fas fa-map text-xs"></i>
              <span>ì§€ë„ë³´ê¸°</span>
            </button>
            {% endif %}
          </div>
          {% if meetup.location_tbd %}
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex items-center gap-2">
              <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-sm"></i>
              <div class="text-sm text-blue-800 dark:text-blue-200 font-medium">
                ì¥ì†Œ ì¶”í›„ ê³µì§€ ì˜ˆì •ì…ë‹ˆë‹¤.
              </div>
            </div>
          </div>
          {% elif meetup.location_full_address %}
          <div class="text-gray-900 dark:text-white mb-3">
            {{ meetup.location_full_address }}
          </div>
          {% endif %}
          {% if meetup.special_notes %}
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 {% if meetup.location_tbd or meetup.location_full_address %}mt-3{% endif %}">
            <div class="flex items-start gap-2">
              <i class="fas fa-exclamation-circle text-yellow-600 dark:text-yellow-400 text-sm mt-0.5"></i>
              <div class="text-sm text-yellow-800 dark:text-yellow-200">
                <strong>íŠ¹ì´ì‚¬í•­:</strong> {{ meetup.special_notes }}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <!-- ê°€ê²© ì •ë³´ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-bitcoin-sign text-orange-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì°¸ê°€ë¹„</h3>
          </div>
          <div class="space-y-4">
            <!-- ë©”ì¸ ê°€ê²© -->
            <div>
              {% if meetup.current_price == 0 %}
              <div class="text-3xl font-bold text-green-600 dark:text-green-400">
                ë¬´ë£Œ
              </div>
              {% elif meetup.is_discounted and meetup.is_early_bird_active %}
              {% if meetup.current_price == 0 %}
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl font-bold text-green-600 dark:text-green-400">
                  ë¬´ë£Œ
                </span>
                <span class="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-full">
                  {{ meetup.public_discount_rate }}% í• ì¸
                </span>
              </div>
              {% else %}
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl font-bold text-gray-900 dark:text-white">
                  {{ meetup.current_price|floatformat:0|intcomma }} sats
                </span>
                <span class="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-full">
                  {{ meetup.public_discount_rate }}% í• ì¸
                </span>
              </div>
              {% endif %}
              {% if meetup.price > 0 %}
              <div class="text-lg text-gray-500 line-through">
                {{ meetup.price|floatformat:0|intcomma }} sats
              </div>
              {% endif %}
              {% else %}
              {% if meetup.current_price == 0 %}
              <div class="text-3xl font-bold text-green-600 dark:text-green-400">
                ë¬´ë£Œ
              </div>
              {% else %}
              <div class="text-3xl font-bold text-gray-900 dark:text-white">
                {{ meetup.current_price|floatformat:0|intcomma }} sats
              </div>
              {% endif %}
              {% endif %}
            </div>
          </div>
        </div>

        <!-- ì°¸ê°€ ì •ì› ì •ë³´ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <i class="fas fa-users text-purple-500 text-lg"></i>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">ì°¸ê°€ ì •ì›</h4>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-user-friends text-sm text-gray-500"></i>
              <span class="text-sm font-medium {% if meetup.is_temporarily_closed %}text-purple-500{% elif meetup.is_expired %}text-gray-500{% elif meetup.is_full %}text-red-500{% elif meetup.remaining_spots <= 5 and meetup.remaining_spots > 0 %}text-orange-500{% else %}text-green-500{% endif %}">
                {% if meetup.is_temporarily_closed %}
                  ì¼ì‹œ ì¤‘ë‹¨
                {% elif meetup.is_expired %}
                  ì¢…ë£Œ
                {% elif meetup.is_full %}
                  ì •ì› ë§ˆê°
                {% elif meetup.remaining_spots is not None %}
                  ë‚¨ì€ìë¦¬: {{ meetup.remaining_spots|intcomma }}ëª…
                {% else %}
                  ì°¸ê°€ ê°€ëŠ¥
                {% endif %}
              </span>
            </div>
          </div>
          
          {% if meetup.max_participants %}
          <div class="space-y-2">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
              <span>í˜„ì¬ ì°¸ê°€ì</span>
              <span>{{ meetup.current_participants|default:0 }}ëª… / {{ meetup.max_participants }}ëª…</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: {% widthratio meetup.current_participants|default:0 meetup.max_participants 100 %}%; max-width: 100%;"></div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- ì˜µì…˜ ì„ íƒ -->
        {% if meetup_options %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ì°¸ê°€ ì˜µì…˜</h3>
          <div class="space-y-4">
            {% for option in meetup_options %}
            <div class="option-group bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4" 
                 data-option-id="{{ option.id }}" 
                 data-required="{{ option.is_required|yesno:'true,false' }}">
              <div class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3">
                <h4>{{ option.name }}</h4>
                {% if option.is_required %}
                <span class="ml-2 px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 text-xs rounded-full">í•„ìˆ˜</span>
                {% endif %}
              </div>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                {% for choice in option.choices.all %}
                <div class="option-choice p-3 border-3 border-black dark:border-white rounded-lg text-center cursor-pointer hover:border-purple-500 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105" 
                   data-option-id="{{ option.id }}" 
                   data-choice-id="{{ choice.id }}"
                   data-choice-price="{{ choice.additional_price }}"
                   onclick="selectOption(this)">
                  <div class="option-title text-xs font-semibold text-gray-900 dark:text-white">{{ choice.name }}</div>
                  {% if choice.additional_price > 0 %}
                    <div class="option-price text-xs text-gray-600 dark:text-gray-400 mt-1 font-medium">
                       + {{ choice.additional_price|floatformat:0|intcomma }} sats
                    </div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- ì°¸ê°€ ì‹ ì²­ ë²„íŠ¼ -->
        <div class="space-y-3">
          {% if meetup.can_participate %}
          <button id="join-meetup-btn" class="w-full py-4 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-xl transition-colors shadow-lg hover:shadow-xl flex items-center justify-center gap-2" 
                  onclick="joinMeetup()">
            <i id="join-icon" class="fas {% if meetup.current_price == 0 %}fa-heart{% else %}fa-calendar-plus{% endif %}"></i>
            <span id="join-text">
              {% if meetup.current_price == 0 %}
              ë¬´ë£Œ ì°¸ê°€ ì‹ ì²­í•˜ê¸°
              {% else %}
              ì°¸ê°€ ì‹ ì²­í•˜ê¸°
              {% endif %}
            </span>
          </button>
          
          <!-- ì •ì› ì„ë°• ê²½ê³  ë©”ì‹œì§€ -->
          {% if meetup.remaining_spots and meetup.remaining_spots <= 3 %}
          <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-3">
            <div class="flex items-center gap-2">
              <i class="fas fa-exclamation-triangle text-orange-600 dark:text-orange-400 text-sm"></i>
              <div class="text-sm text-orange-800 dark:text-orange-200 font-medium">
                âš¡ ë§ˆê° ì„ë°•! í˜„ì¬ {{ meetup.remaining_spots }}ìë¦¬ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤.
              </div>
            </div>
          </div>
          {% endif %}
          <!-- ë¹„íšŒì› ì°¸ê°€ ê°€ëŠ¥ ì•ˆë‚´ -->
          <div class="text-center">
            <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
              <i class="fas fa-user-plus mr-1"></i>ë¹„íšŒì› ì°¸ê°€ ê°€ëŠ¥
            </span>
          </div>
          {% elif meetup.is_expired %}
          <button class="w-full py-4 bg-gray-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-calendar-times"></i>
            <span>ë°‹ì—… ì¢…ë£Œ</span>
          </button>
          <div class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4">
            <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
              <i class="fas fa-info-circle text-gray-500"></i>
              <span class="text-sm">ì´ë¯¸ ì¢…ë£Œëœ ë°‹ì—…ì…ë‹ˆë‹¤. ë‹¤ìŒ ë°‹ì—…ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</span>
            </div>
          </div>
          {% elif meetup.is_temporarily_closed %}
          <button class="w-full py-4 bg-purple-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-pause"></i>
            <span>ì¼ì‹œì¤‘ë‹¨</span>
          </button>
          {% elif meetup.is_full %}
          <button class="w-full py-4 bg-red-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-users-slash"></i>
            <span>ì •ì›ë§ˆê°</span>
          </button>
          {% else %}
          <button class="w-full py-4 bg-gray-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-exclamation-triangle"></i>
            <span>ì°¸ê°€ ë¶ˆê°€</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ë°‹ì—… ì •ë³´ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬ -->
<script type="application/json" id="meetup-data">
{
  "basePrice": {{ meetup.current_price }},
  "meetupId": {{ meetup.id }},
  "storeId": "{{ store.store_id }}",
  "isAuthenticated": {{ user.is_authenticated|yesno:"true,false" }},
  "isStoreOwner": {% if user == store.owner %}true{% else %}false{% endif %},
  "loginUrl": "{% url 'accounts:login' %}",
  "joinMeetupUrl": "#",
  "csrfToken": "{{ csrf_token }}"
}
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Markdown Renderer -->
<script src="{% static 'js/markdown-renderer.js' %}"></script>
<script src="{% static 'js/meetup-detail.js' %}"></script>

<script>
// ë„¤ì´ë²„ì§€ë„ë¡œ ì£¼ì†Œ ê²€ìƒ‰í•˜ì—¬ ìƒˆíƒ­ìœ¼ë¡œ ì´ë™
function openNaverMap(address) {
  if (!address) {
    alert('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  // ë„¤ì´ë²„ì§€ë„ ê²€ìƒ‰ URL (ìƒˆíƒ­ìœ¼ë¡œ ì—´ê¸°)
  const naverMapUrl = `https://map.naver.com/v5/search/${encodeURIComponent(address)}`;
  window.open(naverMapUrl, '_blank', 'noopener,noreferrer');
}

// ì‹¤ì‹œê°„ ì •ì› ìƒíƒœ ì²´í¬
function checkMeetupCapacity() {
  if (!meetupData || !meetupData.storeId || !meetupData.meetupId) return;
  
  fetch(`/api/meetup/${meetupData.storeId}/${meetupData.meetupId}/capacity/`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': meetupData.csrfToken
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateCapacityDisplay(data);
    }
  })
  .catch(error => {
    console.error('ì •ì› ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
  });
}

// ì •ì› í‘œì‹œ ì—…ë°ì´íŠ¸
function updateCapacityDisplay(data) {
  const remainingSpotsElement = document.querySelector('.remaining-spots');
  const progressBar = document.querySelector('.progress-bar');
  const joinButton = document.getElementById('join-meetup-btn');
  
  if (remainingSpotsElement) {
    if (data.is_full) {
      remainingSpotsElement.textContent = 'ì •ì› ë§ˆê°';
      remainingSpotsElement.className = 'text-sm font-medium text-red-500';
    } else if (data.remaining_spots !== null) {
      remainingSpotsElement.textContent = `ë‚¨ì€ìë¦¬: ${data.remaining_spots.toLocaleString()}ëª…`;
      
      if (data.remaining_spots <= 3) {
        remainingSpotsElement.className = 'text-sm font-medium text-red-500';
        showCapacityWarning(data.remaining_spots);
      } else if (data.remaining_spots <= 5) {
        remainingSpotsElement.className = 'text-sm font-medium text-orange-500';
      } else {
        remainingSpotsElement.className = 'text-sm font-medium text-green-500';
      }
    }
  }
  
  // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
  if (progressBar && data.max_participants) {
    const percentage = Math.min((data.current_participants / data.max_participants) * 100, 100);
    progressBar.style.width = `${percentage}%`;
  }
  
  // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  if (joinButton && data.is_full) {
    joinButton.disabled = true;
    joinButton.classList.add('opacity-50', 'cursor-not-allowed');
    joinButton.innerHTML = '<i class="fas fa-users-slash"></i><span>ì •ì›ë§ˆê°</span>';
  }
}

// ì •ì› ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ
function showCapacityWarning(remainingSpots) {
  // ê¸°ì¡´ ê²½ê³  ë©”ì‹œì§€ê°€ ì—†ì„ ë•Œë§Œ í‘œì‹œ
  if (!document.querySelector('.capacity-warning')) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'capacity-warning bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3 mt-3';
    warningDiv.innerHTML = `
      <div class="flex items-center gap-2">
        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-sm"></i>
        <div class="text-sm text-red-800 dark:text-red-200 font-medium">
          ğŸš¨ ë§ˆê° ì„ë°•! í˜„ì¬ ${remainingSpots}ìë¦¬ë§Œ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì„œë‘˜ëŸ¬ ì‹ ì²­í•˜ì„¸ìš”!
        </div>
      </div>
    `;
    
    const participantSection = document.querySelector('.space-y-3');
    if (participantSection) {
      participantSection.appendChild(warningDiv);
    }
  }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ 1íšŒ ì²´í¬, ì´í›„ 30ì´ˆë§ˆë‹¤ ì²´í¬
document.addEventListener('DOMContentLoaded', function() {
  checkMeetupCapacity();
  setInterval(checkMeetupCapacity, 30000); // 30ì´ˆë§ˆë‹¤ ì²´í¬
});
</script>
{% endblock %} 