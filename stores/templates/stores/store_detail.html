{% extends 'stores/store_base.html' %}
{% load static %}
{% load markdown_extras %}
{% load humanize %}

{% block title %}{{ store.store_name }} - SatoShop{% endblock %}



{% block extra_css %}
{{ block.super }}
<style>
  .store-header {
    background: var(--hero-gradient, linear-gradient(135deg, #3b82f6, #8b5cf6));
    color: var(--hero-text-color, white);
  }
  .store-header h1,
  .store-header p {
    color: var(--hero-text-color, white) !important;
  }
  @media (prefers-color-scheme: dark) {
    .store-header h1,
    .store-header p {
      color: var(--hero-text-color, white) !important;
    }
  }
</style>
{% endblock %}

{% block store_content %}
<!-- 스토어 헤더 -->
<section class="store-header py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center relative">
      <div class="flex flex-col items-center justify-center">
        <div class="flex-shrink-0">
          <h1 class="text-5xl font-bold mb-4 text-white">
            <i class="fas fa-store mr-4"></i>
            {{ store.store_name }}
          </h1>
        </div>
        
        <p class="text-2xl text-white mb-6">
          주인장: {{ store.owner_name }}
        </p>
      </div>
    </div>
  </div>
</section>

<!-- 스토어 소개 및 커버 이미지 -->
<section class="py-8 bg-gray-50 dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- 왼쪽: 스토어 소개 + 커버 이미지 -->
      <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <i class="fas fa-info-circle text-blue-500 mr-3"></i>
            스토어 소개
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- 왼쪽: 스토어 설명 -->
            <div>
              {% if store.store_description %}
              <div class="prose max-w-none">
                {{ store.store_description|markdown_to_html }}
              </div>
              {% else %}
              <div class="text-gray-500 dark:text-gray-400 italic">
                <p>아직 스토어 설명이 등록되지 않았습니다.</p>
              </div>
              {% endif %}
            </div>

            <!-- 오른쪽: 커버 이미지 -->
            <div>
              {% if store.images.exists %}
              <div class="aspect-video rounded-lg overflow-hidden">
                {% with store.images.first as store_image %}
                  <img src="{{ store_image.file_url }}" alt="{{ store_image.original_name }}" loading="lazy"
                    onclick="openImageModal('{{ store_image.file_url }}', '{{ store_image.original_name }}')"
                    class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-200">
                {% endwith %}
              </div>
              {% else %}
              <div class="aspect-video rounded-lg bg-gray-100 dark:bg-gray-700 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500">
                <i class="fas fa-image text-4xl mb-2"></i>
                <p>등록된 이미지가 없습니다</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- 오른쪽: 주인장 정보 -->
      <div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center">
            <i class="fas fa-user text-blue-500 mr-3"></i>
            주인장 정보
          </h3>

          <div class="space-y-4">
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">{{ store.owner_name }}</h4>

            {% if store.owner_phone %}
            <div class="flex items-center text-gray-600 dark:text-gray-400">
              <i class="fas fa-phone text-blue-500 mr-3"></i>
              <a href="tel:{{ store.owner_phone }}" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">{{ store.owner_phone }}</a>
            </div>
            {% endif %}

            {% if store.owner_email %}
            <div class="flex items-center text-gray-600 dark:text-gray-400">
              <i class="fas fa-envelope text-blue-500 mr-3"></i>
              <a href="mailto:{{ store.owner_email }}" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">{{ store.owner_email }}</a>
            </div>
            {% endif %}


          </div>

          <div class="mt-6">
            <a href="{{ store.chat_channel }}" target="_blank" class="w-full inline-flex items-center justify-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
              <i class="fas fa-comments mr-2"></i>
              소통 채널 접속
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- 상품 목록 -->
<section id="products-section" class="py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
        <i class="fas fa-shopping-bag text-blue-500 mr-3"></i>
        상품 목록
      </h2>
      <a href="{% url 'products:public_product_list' store.store_id %}" 
         class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-sm">
        <span>전체보기</span>
        <i class="fas fa-arrow-right ml-2"></i>
      </a>
    </div>

    <!-- 상품 그리드 (1줄만 표시) -->
    {% if products %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {% for product in products|slice:":4" %}
      <!-- 공개 뷰에서는 활성화된 상품만 표시 -->
      {% if product.is_active %}
      <div class="bg-white dark:bg-gray-800 {% if product.is_discounted %}border-2 border-red-500 rounded-none{% else %}rounded-2xl{% endif %} shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
        <!-- 상품 이미지 -->
        <div class="relative aspect-square">
          <!-- 태그들 (할인, 재고 상태) -->
          <div class="absolute top-3 left-3 z-10 flex flex-col gap-1">
            {% if product.is_discounted %}
            <div class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-medium">
              {{ product.public_discount_rate }}% 할인
            </div>
            {% endif %}
            
            <!-- 재고 상태 태그 -->
            <div class="{% if product.is_temporarily_out_of_stock %}bg-purple-500{% elif product.stock_quantity == 0 %}bg-red-500{% elif product.stock_quantity <= 5 %}bg-orange-500{% else %}bg-green-500{% endif %} text-white px-2 py-1 rounded-lg text-xs font-medium">
              {% if product.is_temporarily_out_of_stock %}
                일시품절
              {% elif product.stock_quantity == 0 %}
                품절
              {% else %}
                재고 {{ product.stock_quantity|intcomma }}개
              {% endif %}
            </div>
          </div>
          
          <a href="{% url 'stores:product_detail' store.store_id product.id %}">
            {% if product.images.exists %}
            <img src="{{ product.images.first.file_url }}" alt="{{ product.title }}" 
                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
            {% else %}
            <div class="w-full h-full bg-gray-100 dark:bg-gray-700 flex flex-col items-center justify-center">
              <i class="fas fa-image text-gray-400 text-4xl mb-2"></i>
              <span class="text-gray-500 dark:text-gray-400 text-sm">이미지 없음</span>
            </div>
            {% endif %}
          </a>
        </div>

        <div class="p-4">
          <div class="mb-4">
            <a href="{% url 'stores:product_detail' store.store_id product.id %}" class="block hover:text-orange-500 transition-colors">
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 line-clamp-2">
                {{ product.title }}
              </h4>
            </a>

            <!-- 가격 정보 -->
            <div class="mb-3">
              {% if product.is_discounted %}
              <div class="flex items-center space-x-2 mb-1">
                <span class="text-xl font-bold text-red-500">
                  {{ product.public_discounted_price|floatformat:0|intcomma }} sats
                </span>
                <span class="text-sm text-gray-500 dark:text-gray-400 line-through">
                  {{ product.public_price|floatformat:0|intcomma }} sats
                </span>
              </div>
              {% else %}
              <div class="flex items-center">
                <span class="text-xl font-bold text-gray-900 dark:text-white">
                  {{ product.public_price|floatformat:0|intcomma }} sats
                </span>
              </div>
              {% endif %}
            </div>

            <!-- 액션 버튼 -->
            <div class="flex gap-2">
              {% if product.is_active and product.stock_quantity > 0 and not product.is_temporarily_out_of_stock %}
              <a href="{% url 'stores:product_detail' store.store_id product.id %}" 
                 class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors text-sm">
                <i class="fas fa-eye mr-1"></i>
                상품보기
              </a>
              {% elif product.is_temporarily_out_of_stock %}
              <button class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-purple-400 text-white rounded-lg cursor-not-allowed text-sm" disabled>
                <i class="fas fa-pause mr-1"></i>
                일시품절
              </button>
              {% elif product.stock_quantity == 0 %}
              <button class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-red-400 text-white rounded-lg cursor-not-allowed text-sm" disabled>
                <i class="fas fa-times mr-1"></i>
                품절
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% else %}
    <!-- 상품이 없을 때 -->
    <div class="text-center py-12">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-100 dark:bg-orange-900 rounded-full mb-4">
          <i class="fas fa-shopping-bag text-3xl text-orange-600 dark:text-orange-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">등록된 상품이 없습니다</h3>
        <p class="text-gray-600 dark:text-gray-400">아직 등록된 상품이 없습니다. 곧 새로운 상품이 추가될 예정입니다.</p>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- 밋업 목록 -->
<section id="meetups-section" class="py-8 bg-gray-50 dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
        <i class="fas fa-users text-purple-500 mr-3"></i>
        밋업 목록
      </h2>
      <a href="{% url 'meetup:public_meetup_list' store.store_id %}" 
         class="inline-flex items-center px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors text-sm">
        <span>전체보기</span>
        <i class="fas fa-arrow-right ml-2"></i>
      </a>
    </div>

    <!-- 밋업 그리드 (1줄만 표시) -->
    {% if meetups %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {% for meetup in meetups|slice:":4" %}
      <!-- 활성화된 밋업만 표시 -->
      {% if meetup.is_active %}
      <div class="bg-white dark:bg-gray-800 {% if meetup.is_discounted %}border-2 border-red-500 rounded-none{% else %}rounded-2xl{% endif %} shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
        <!-- 밋업 이미지 -->
        <div class="relative aspect-square">
          <!-- 태그들 (할인, 참가 상태) -->
          <div class="absolute top-3 left-3 z-10 flex flex-col gap-1">
            {% if meetup.is_discounted %}
            <div class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-medium">
              {{ meetup.public_discount_rate }}% 할인
            </div>
            {% endif %}
            
            <!-- 참가 상태 태그 -->
            {% if meetup.is_full %}
            <div class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-medium">
              정원마감
            </div>
            {% elif meetup.is_temporarily_closed %}
            <div class="bg-purple-500 text-white px-2 py-1 rounded-lg text-xs font-medium">
              일시중단
            </div>
            {% else %}
            <div class="bg-green-500 text-white px-2 py-1 rounded-lg text-xs font-medium">
              참가가능
            </div>
            {% endif %}
          </div>
          
          <a href="{% url 'meetup:meetup_detail' store.store_id meetup.id %}">
            {% if meetup.images.exists %}
            <img src="{{ meetup.images.first.file_url }}" alt="{{ meetup.name }}" 
                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-300">
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-purple-50 to-indigo-50 dark:bg-gray-700 flex flex-col items-center justify-center">
              <i class="fas fa-users text-purple-400 dark:text-purple-300 text-4xl mb-2"></i>
              <span class="text-purple-500 dark:text-purple-400 text-sm">이미지 없음</span>
            </div>
            {% endif %}
          </a>
        </div>

        <!-- 밋업 정보 -->
        <div class="p-4">
          <!-- 밋업 제목 -->
          <div class="mb-2">
            <a href="{% url 'meetup:meetup_detail' store.store_id meetup.id %}" 
               class="text-lg font-semibold text-gray-900 dark:text-white hover:text-purple-600 dark:hover:text-purple-400 transition-colors line-clamp-2">
              {{ meetup.name }}
            </a>
          </div>

          <!-- 일정 정보 -->
          {% if meetup.date_time %}
          <div class="mb-3 flex items-center gap-2">
            <i class="fas fa-calendar text-sm text-gray-500"></i>
            <span class="text-sm text-gray-600 dark:text-gray-400">
              {{ meetup.date_time|date:"Y년 m월 d일 H:i" }}
            </span>
          </div>
          {% endif %}

          <!-- 가격 정보 -->
          <div class="mb-3">
            {% if meetup.is_discounted %}
            <div class="flex items-center space-x-2">
              <span class="text-lg font-bold text-red-500">
                {{ meetup.public_discounted_price|floatformat:0|intcomma }} sats
              </span>
              <span class="text-sm text-gray-500 dark:text-gray-400 line-through">
                {{ meetup.public_price|floatformat:0|intcomma }} sats
              </span>
            </div>
            {% else %}
            <div class="flex items-center">
              <span class="text-lg font-bold text-gray-900 dark:text-white">
                {% if meetup.price == 0 %}
                  무료
                {% else %}
                  {{ meetup.public_price|floatformat:0|intcomma }} sats
                {% endif %}
              </span>
            </div>
            {% endif %}
          </div>

          <!-- 액션 버튼 -->
          <div class="flex gap-2">
            {% if meetup.can_participate %}
            <a href="{% url 'meetup:meetup_detail' store.store_id meetup.id %}" 
               class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm">
              <i class="fas fa-calendar-plus mr-1"></i>
              참가하기
            </a>
            {% elif meetup.is_expired %}
            <button class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-gray-400 text-white rounded-lg cursor-not-allowed text-sm" disabled>
              <i class="fas fa-calendar-times mr-1"></i>
              종료
            </button>
            {% elif meetup.is_temporarily_closed %}
            <button class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-purple-400 text-white rounded-lg cursor-not-allowed text-sm" disabled>
              <i class="fas fa-pause mr-1"></i>
              일시중단
            </button>
            {% elif meetup.is_full %}
            <button class="flex-1 inline-flex items-center justify-center px-3 py-2 bg-red-400 text-white rounded-lg cursor-not-allowed text-sm" disabled>
              <i class="fas fa-users-slash mr-1"></i>
              정원마감
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
    {% else %}
    <!-- 밋업이 없을 때 -->
    <div class="text-center py-12">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-100 dark:bg-purple-900 rounded-full mb-4">
          <i class="fas fa-users text-3xl text-purple-600 dark:text-purple-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">등록된 밋업이 없습니다</h3>
        <p class="text-gray-600 dark:text-gray-400">아직 등록된 밋업이 없습니다. 곧 새로운 밋업이 추가될 예정입니다.</p>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- 이미지 모달 -->
{% if store.images.exists %}
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
  <div class="relative max-w-4xl max-h-full p-4">
    <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
    <button onclick="closeImageModal()" class="absolute top-2 right-2 w-10 h-10 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center text-white transition-colors">
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/store-detail.js' %}"></script>
{% endblock %}