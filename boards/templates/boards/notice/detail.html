{% extends 'myshop/base.html' %}
{% load static %}
{% load static_versioned %}

{% block title %}{{ notice.title }} - 공지사항{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static_v 'css/boards.css' %}">
<style>
/* 다크모드 대응 인라인 스타일 */
.pinned-badge {
    margin-bottom: 15px; 
    display: inline-block;
}

.back-button {
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="notice-container">
    <!-- 뒤로가기 -->
    <div class="back-button">
        <a href="{% url 'boards:notice_list' %}" class="btn-notice btn-secondary">
            ← 목록으로
        </a>
    </div>

    <!-- 공지사항 상세 -->
    <div class="notice-detail">
        <!-- 헤더 -->
        <div class="notice-detail-header">
            {% if notice.is_pinned %}
                <span class="notice-badge pinned pinned-badge">고정</span>
            {% endif %}
            <h1 class="notice-detail-title">{{ notice.title }}</h1>
            <div class="notice-detail-meta">
                <span>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                    </svg>
                    {{ notice.author.username }}
                </span>
                <span>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4 .5a.5.5 0 0 0-1 0V1H2a2 2 0 0 0-2 2v1h16V3a2 2 0 0 0-2-2h-1V.5a.5.5 0 0 0-1 0V1H4V.5zM16 14V5H0v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2z"/>
                    </svg>
                    {{ notice.created_at|date:"Y년 m월 d일 H:i" }}
                </span>
                {% if notice.updated_at != notice.created_at %}
                    <span>
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM11 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 17 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5z"/>
                            <path d="M.5 11a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 15.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
                        </svg>
                        수정: {{ notice.updated_at|date:"Y.m.d H:i" }}
                    </span>
                {% endif %}
                <span>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                    </svg>
                    조회수 {{ notice.views }}
                </span>
            </div>
        </div>

        <!-- 내용 -->
        <div class="notice-detail-content">
            {{ notice.content|linebreaks }}
        </div>

        <!-- 액션 버튼들 -->
        {% if can_edit %}
            <div class="notice-detail-actions">
                <a href="{% url 'boards:notice_edit' pk=notice.pk %}" class="btn-notice btn-secondary">수정</a>
                <a href="{% url 'boards:notice_delete' pk=notice.pk %}" class="btn-notice btn-danger delete-notice-btn">삭제</a>
            </div>
        {% endif %}
    </div>

    <!-- 댓글 섹션 -->
    <div class="comments-section">
        <div class="comments-header">
            댓글 ({{ comments.count }})
        </div>

        <!-- 댓글 작성 폼 -->
        <div class="comment-form">
            <form method="post" action="{% url 'boards:comment_create' notice_pk=notice.pk %}" class="comment-form">
                {% csrf_token %}
                <textarea name="content" 
                         placeholder="댓글을 입력하세요..." 
                         class="comment-textarea" 
                         required></textarea>
                <div class="comment-form-actions">
                    <button type="submit" class="btn-notice btn-primary">댓글 작성</button>
                </div>
            </form>
        </div>

        <!-- 댓글 목록 -->
        {% if comments %}
            <div class="comments-list">
                {% for comment in comments %}
                    <div class="comment-item">
                        <!-- 댓글 헤더 -->
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.author.username }}</span>
                            <span class="comment-date">{{ comment.created_at|date:"Y.m.d H:i" }}</span>
                        </div>

                        <!-- 댓글 내용 -->
                        <div class="comment-content" id="comment-content-{{ comment.pk }}">
                            {{ comment.content|linebreaks }}
                        </div>

                        <!-- 댓글 수정 폼 (숨김) -->
                        <div class="comment-edit-form" id="edit-form-{{ comment.pk }}" style="display: none;">
                            <form method="post" action="{% url 'boards:comment_edit' comment_pk=comment.pk %}">
                                {% csrf_token %}
                                <textarea name="content" class="comment-textarea" required>{{ comment.content }}</textarea>
                                <div class="comment-form-actions">
                                    <button type="submit" class="btn-notice btn-success">수정 완료</button>
                                    <button type="button" class="btn-notice btn-secondary edit-cancel-btn" data-comment-id="{{ comment.pk }}">취소</button>
                                </div>
                            </form>
                        </div>

                        <!-- 댓글 액션 -->
                        <div class="comment-actions">
                            <a href="#" class="comment-action reply-btn" data-comment-id="{{ comment.pk }}">답글</a>
                            {% if user == comment.author %}
                                <a href="#" class="comment-action comment-edit-btn" data-comment-id="{{ comment.pk }}">수정</a>
                                <form method="post" action="{% url 'boards:comment_delete' comment_pk=comment.pk %}" style="display: inline;" class="comment-delete-form">
                                    {% csrf_token %}
                                    <button type="submit" class="comment-action" style="background: none; border: none; color: inherit; cursor: pointer;">삭제</button>
                                </form>
                            {% endif %}
                        </div>

                        <!-- 답글 작성 폼 (숨김) -->
                        <div class="reply-form" id="reply-form-{{ comment.pk }}">
                            <form method="post" action="{% url 'boards:comment_create' notice_pk=notice.pk %}">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comment.pk }}">
                                <textarea name="content" 
                                         placeholder="답글을 입력하세요..." 
                                         class="reply-textarea" 
                                         required></textarea>
                                <div class="comment-form-actions">
                                    <button type="submit" class="btn-notice btn-success">답글 작성</button>
                                    <button type="button" class="btn-notice btn-secondary reply-cancel-btn" data-comment-id="{{ comment.pk }}">취소</button>
                                </div>
                            </form>
                        </div>

                        <!-- 대댓글 목록 -->
                        {% for reply in comment.replies.all %}
                            {% if reply.is_active %}
                                <div class="reply-item">
                                    <div class="comment-header">
                                        <span class="comment-author">{{ reply.author.username }}</span>
                                        <span class="comment-date">{{ reply.created_at|date:"Y.m.d H:i" }}</span>
                                    </div>
                                    <div class="comment-content" id="comment-content-{{ reply.pk }}">
                                        {{ reply.content|linebreaks }}
                                    </div>
                                    
                                    <!-- 대댓글 수정 폼 (숨김) -->
                                    <div class="comment-edit-form" id="edit-form-{{ reply.pk }}" style="display: none;">
                                        <form method="post" action="{% url 'boards:comment_edit' comment_pk=reply.pk %}">
                                            {% csrf_token %}
                                            <textarea name="content" class="comment-textarea" required>{{ reply.content }}</textarea>
                                            <div class="comment-form-actions">
                                                <button type="submit" class="btn-notice btn-success">수정 완료</button>
                                                <button type="button" class="btn-notice btn-secondary edit-cancel-btn" data-comment-id="{{ reply.pk }}">취소</button>
                                            </div>
                                        </form>
                                    </div>

                                    {% if user == reply.author %}
                                        <div class="comment-actions">
                                            <a href="#" class="comment-action comment-edit-btn" data-comment-id="{{ reply.pk }}">수정</a>
                                            <form method="post" action="{% url 'boards:comment_delete' comment_pk=reply.pk %}" style="display: inline;" class="comment-delete-form">
                                                {% csrf_token %}
                                                <button type="submit" class="comment-action" style="background: none; border: none; color: inherit; cursor: pointer;">삭제</button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">💬</div>
                <h3 class="empty-state-title">첫 댓글을 작성해보세요</h3>
                <p class="empty-state-description">이 공지사항에 대한 의견을 남겨주세요.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static_v 'js/boards.js' %}"></script>
{% endblock %} 