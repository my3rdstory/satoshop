name: í™˜ìœ¨ ìë™ ì—…ë°ì´íŠ¸ (ë©€í‹° ì„œë²„ ì›¹í›… ë°©ì‹)

on:
  schedule:
    # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '*/10 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: false
        default: 'false'

jobs:
  update-exchange-rate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ (ë©€í‹° ì„œë²„)
      env:
        WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
      run: |
        echo "ğŸš€ GitHub Actionsì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ ì‹œì‘"
        echo "â° ì‹œì‘ ì‹œê°„: $(date)"
        echo "ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ë©€í‹° ì„œë²„ ì›¹í›… ë°©ì‹"
        
        # ì›¹í›… í† í° í™•ì¸
        if [ -z "$WEBHOOK_TOKEN" ]; then
          echo "âŒ WEBHOOK_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "GitHub Secretsì—ì„œ WEBHOOK_TOKENì„ ì„¤ì •í•˜ì„¸ìš”."
          echo "í† í° ìƒì„±: uv run python scripts/generate_webhook_token.py"
          exit 1
        fi
        
        echo "ğŸ” í† í° ì„¤ì •: âœ… (ê¸¸ì´: ${#WEBHOOK_TOKEN}ì)"
        
        # ì„œë²„ URL ëª©ë¡ ì •ì˜
        WEBHOOK_URLS=(
          "https://satoshop-dev.onrender.com/webhook/update-exchange-rate/"
          "https://satoshop.onrender.com/webhook/update-exchange-rate/"
          "https://store.btcmap.kr/webhook/update-exchange-rate/"
        )
        
        # ê° ì„œë²„ì— ì›¹í›… í˜¸ì¶œ
        success_count=0
        total_count=${#WEBHOOK_URLS[@]}
        
        for i in "${!WEBHOOK_URLS[@]}"; do
          url="${WEBHOOK_URLS[$i]}"
          server_name=$(echo "$url" | sed 's|https://||' | sed 's|/.*||')
          
          echo ""
          echo "ğŸ“ ì„œë²„ $((i+1))/$total_count: $server_name"
          echo "ğŸŒ URL: $url"
          
          # ì›¹í›… í˜¸ì¶œ
          response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{\"token\": \"${WEBHOOK_TOKEN}\", \"source\": \"github_actions\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}" \
            "$url")
          
          # ì‘ë‹µ íŒŒì‹±
          body=$(echo "$response" | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')
          code=$(echo "$response" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
          
          echo "ğŸ“Š HTTP ì‘ë‹µ ì½”ë“œ: $code"
          
          # ê²°ê³¼ ì²˜ë¦¬
          case $code in
            200)
              echo "âœ… $server_name: í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
              success_count=$((success_count + 1))
              ;;
            401)
              echo "âŒ $server_name: ì¸ì¦ ì‹¤íŒ¨ (HTTP 401)"
              echo "ğŸ”‘ WEBHOOK_TOKENì´ ì„œë²„ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              ;;
            404)
              echo "âŒ $server_name: ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (HTTP 404)"
              echo "ğŸŒ ì›¹í›… URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”."
              ;;
            500)
              echo "âŒ $server_name: ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ (HTTP 500)"
              echo "ğŸ”§ ì„œë²„ì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
              ;;
            000)
              echo "âŒ $server_name: ì—°ê²° ì‹¤íŒ¨ (íƒ€ì„ì•„ì›ƒ ë˜ëŠ” ì„œë²„ ë‹¤ìš´)"
              echo "ğŸŒ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
              ;;
            *)
              echo "âŒ $server_name: ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ (HTTP $code)"
              echo "ğŸŒ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
              ;;
          esac
        done
        
        echo ""
        echo "ğŸ“Š ìµœì¢… ê²°ê³¼: $success_count/$total_count ì„œë²„ ì„±ê³µ"
        echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
        
        # ëª¨ë“  ì„œë²„ê°€ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ exit 1
        if [ $success_count -eq 0 ]; then
          echo "âŒ ëª¨ë“  ì„œë²„ì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
          exit 1
        else
          echo "âœ… $success_countê°œ ì„œë²„ì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì„±ê³µ!"
        fi
    
    - name: ì‹¤í–‰ ê²°ê³¼ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
      if: failure()
      run: |
        echo ""
        echo "ğŸ†˜ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ ì‹¤íŒ¨!"
        echo "=================================="
        echo ""
        echo "ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
        echo "1. GitHub Secrets ì„¤ì • í™•ì¸:"
        echo "   - WEBHOOK_TOKEN: ì•ˆì „í•œ í† í° ê°’"
        echo ""
        echo "2. ì„œë²„ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸ (ê° ì„œë²„ë³„):"
        echo "   - WEBHOOK_TOKEN: GitHubê³¼ ë™ì¼í•œ ê°’"
        echo ""
        echo "3. ì„œë²„ ìƒíƒœ í™•ì¸:"
        echo "   - satoshop-dev.onrender.com"
        echo "   - satoshop.onrender.com" 
        echo "   - store.btcmap.kr"
        echo ""
        echo "4. ë¡œê·¸ í™•ì¸:"
        echo "   - GitHub Actions ë¡œê·¸: https://github.com/${{ github.repository }}/actions"
        echo "   - ê° ì„œë²„ ë¡œê·¸: Render.com Dashboard ë˜ëŠ” ì„œë²„ ë¡œê·¸"
        echo ""
        echo "ğŸ’¡ ë„ì›€ë§: WEBHOOK_SETUP_GUIDE.md íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”." 