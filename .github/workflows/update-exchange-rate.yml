name: í™˜ìœ¨ ìë™ ì—…ë°ì´íŠ¸ (ì›¹í›… ë°©ì‹)

on:
  schedule:
    # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '*/5 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: false
        default: 'false'

jobs:
  update-exchange-rate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        WEBHOOK_TOKEN: ${{ secrets.WEBHOOK_TOKEN }}
      run: |
        echo "ğŸš€ GitHub Actionsì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ ì‹œì‘"
        echo "â° ì‹œì‘ ì‹œê°„: $(date)"
        echo "ğŸ”§ ì‹¤í–‰ ëª¨ë“œ: ì›¹í›… ë°©ì‹ (DB ì§ì ‘ ì—°ê²° ì•ˆí•¨)"
        
        # í™˜ê²½ë³€ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if [ -z "$WEBHOOK_URL" ]; then
          echo "âŒ WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "GitHub Secretsì—ì„œ WEBHOOK_URLì„ ì„¤ì •í•˜ì„¸ìš”."
          echo "ì˜ˆì‹œ: https://your-render-app.onrender.com/webhook/update-exchange-rate/"
          exit 1
        fi
        
        if [ -z "$WEBHOOK_TOKEN" ]; then
          echo "âŒ WEBHOOK_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "GitHub Secretsì—ì„œ WEBHOOK_TOKENì„ ì„¤ì •í•˜ì„¸ìš”."
          echo "í† í° ìƒì„±: uv run python scripts/generate_webhook_token.py"
          exit 1
        fi
        
        echo "ğŸ“¡ ì„œë²„ URL: ${WEBHOOK_URL}"
        echo "ğŸ” í† í° ì„¤ì •: âœ… (ê¸¸ì´: ${#WEBHOOK_TOKEN}ì)"
        
        # ì›¹í›… í˜¸ì¶œ
        echo "ğŸ“ ì›¹í›… í˜¸ì¶œ ì¤‘..."
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" \
          --connect-timeout 10 \
          --max-time 30 \
          -X POST \
          -H "Content-Type: application/json" \
          -d "{\"token\": \"${WEBHOOK_TOKEN}\", \"source\": \"github_actions\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"}" \
          "${WEBHOOK_URL}")
        
        # ì‘ë‹µ íŒŒì‹±
        body=$(echo "$response" | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')
        code=$(echo "$response" | tr -d '\n' | sed -E 's/.*HTTPSTATUS:([0-9]{3})$/\1/')
        
        echo "ğŸ“Š HTTP ì‘ë‹µ ì½”ë“œ: $code"
        echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©: $body"
        
        # ê²°ê³¼ ì²˜ë¦¬
        case $code in
          200)
            echo "âœ… í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ ì„±ê³µ!"
            echo "ğŸ‰ í™˜ìœ¨ì´ ì •ìƒì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            ;;
          401)
            echo "âŒ ì¸ì¦ ì‹¤íŒ¨ (HTTP 401)"
            echo "ğŸ”‘ WEBHOOK_TOKENì´ ì„œë²„ì™€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ í•´ê²°ë°©ë²•: GitHub Secretsì™€ ì„œë²„ í™˜ê²½ë³€ìˆ˜ì˜ WEBHOOK_TOKENì„ í™•ì¸í•˜ì„¸ìš”."
            exit 1
            ;;
          404)
            echo "âŒ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (HTTP 404)"
            echo "ğŸŒ WEBHOOK_URLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”."
            echo "ğŸ’¡ ì˜¬ë°”ë¥¸ URL: https://your-domain.com/webhook/update-exchange-rate/"
            exit 1
            ;;
          500)
            echo "âŒ ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ (HTTP 500)"
            echo "ğŸ”§ ì„œë²„ì—ì„œ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            echo "ğŸ“Š ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
            ;;
          *)
            echo "âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ (HTTP $code)"
            echo "ğŸŒ ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
            ;;
        esac
        
        echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
    
    - name: ì‹¤í–‰ ê²°ê³¼ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
      if: failure()
      run: |
        echo ""
        echo "ğŸ†˜ í™˜ìœ¨ ì—…ë°ì´íŠ¸ ì›¹í›… í˜¸ì¶œ ì‹¤íŒ¨!"
        echo "=================================="
        echo ""
        echo "ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
        echo "1. GitHub Secrets ì„¤ì • í™•ì¸:"
        echo "   - WEBHOOK_URL: https://your-domain.com/webhook/update-exchange-rate/"
        echo "   - WEBHOOK_TOKEN: ì•ˆì „í•œ í† í° ê°’"
        echo ""
        echo "2. ì„œë²„ í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸:"
        echo "   - WEBHOOK_TOKEN: GitHubê³¼ ë™ì¼í•œ ê°’"
        echo ""
        echo "3. ì„œë²„ ìƒíƒœ í™•ì¸:"
        echo "   - ì„œë²„ê°€ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸"
        echo "   - ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸"
        echo ""
        echo "4. ë¡œê·¸ í™•ì¸:"
        echo "   - GitHub Actions ë¡œê·¸: https://github.com/${{ github.repository }}/actions"
        echo "   - ì„œë²„ ë¡œê·¸: Render.com Dashboard"
        echo ""
        echo "ğŸ’¡ ë„ì›€ë§: WEBHOOK_SETUP_GUIDE.md íŒŒì¼ì„ ì°¸ì¡°í•˜ì„¸ìš”." 