{% extends 'stores/store_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ live_lecture.name }} - {{ store.store_name }}{% endblock %}

<!-- ë¼ì´ë¸Œ ê°•ì˜ë³„ ì˜¤í”ˆê·¸ë˜í”„ ì„¤ì • -->
{% block og_title %}{{ live_lecture.name }} - {{ store.store_name }}{% endblock %}
{% block og_description %}{% if live_lecture.description %}{{ live_lecture.description|truncatewords:30 }}{% else %}{{ store.store_name }}ì—ì„œ ì§„í–‰í•˜ëŠ” ë¼ì´ë¸Œ ê°•ì˜ - {{ live_lecture.name }}{% endif %}{% endblock %}
{% block og_type %}event{% endblock %}
{% block og_image %}{% if live_lecture.images.exists %}{{ live_lecture.images.first.file_url }}{% elif store and store.images.exists %}{{ store.images.first.file_url }}{% elif site_settings and site_settings.og_default_image %}{{ site_settings.og_default_image }}{% else %}{% static 'images/satoshop-logo-1x1-favicon.png' %}{% endif %}{% endblock %}

{% block twitter_title %}{{ live_lecture.name }} - {{ store.store_name }}{% endblock %}
{% block twitter_description %}{% if live_lecture.description %}{{ live_lecture.description|truncatewords:30 }}{% else %}{{ store.store_name }}ì—ì„œ ì§„í–‰í•˜ëŠ” ë¼ì´ë¸Œ ê°•ì˜ - {{ live_lecture.name }}{% endif %}{% endblock %}
{% block twitter_image %}{% if live_lecture.images.exists %}{{ live_lecture.images.first.file_url }}{% elif store and store.images.exists %}{{ store.images.first.file_url }}{% elif site_settings and site_settings.og_default_image %}{{ site_settings.og_default_image }}{% else %}{% static 'images/satoshop-logo-1x1-favicon.png' %}{% endif %}{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<!-- Markdown Renderer CSS -->
<link rel="stylesheet" href="{% static 'css/markdown-renderer.css' %}">
<link rel="stylesheet" href="{% static 'css/lecture_live_detail.css' %}">
{% endblock %}

{% block store_content %}
{% csrf_token %}
<div class="bg-gray-50 dark:bg-gray-900 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- ì™¼ìª½: ë¼ì´ë¸Œ ê°•ì˜ ì´ë¯¸ì§€, ì†Œê°œ, ê°•ì‚¬ ì—°ë½ì²˜ -->
      <div class="space-y-6">
        <!-- ë¼ì´ë¸Œ ê°•ì˜ ì´ë¯¸ì§€ -->
        <div class="space-y-4">
          <!-- ë©”ì¸ ì´ë¯¸ì§€ -->
          <div class="lecture-image-container relative">
            {% if live_lecture.images.exists %}
            <img src="{{ live_lecture.images.first.file_url }}" alt="{{ live_lecture.name }}" 
                 class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full flex items-center justify-center">
              <div class="text-center text-purple-400 dark:text-purple-300">
                <i class="fas fa-video text-6xl mb-4"></i>
                <div class="text-lg">ì´ë¯¸ì§€ ì—†ìŒ</div>
              </div>
            </div>
            {% endif %}
            

          </div>
        </div>

        <!-- ë¼ì´ë¸Œ ê°•ì˜ ì†Œê°œ -->
        {% if live_lecture.description %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-info-circle text-blue-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ê°•ì˜ ì†Œê°œ</h3>
          </div>
          <div class="prose max-w-none markdown-content text-gray-900 dark:text-white" data-markdown="{{ live_lecture.description|escape }}">
            <!-- ë§ˆí¬ë‹¤ìš´ ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
          </div>
        </div>
        {% endif %}

        <!-- ê°•ì‚¬ ì •ë³´ -->
        {% if live_lecture.instructor_contact or live_lecture.instructor_email or live_lecture.instructor_chat_channel %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-chalkboard-teacher text-purple-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ê°•ì‚¬ ì •ë³´</h3>
          </div>
          <div class="space-y-3">
            {% if live_lecture.instructor_contact %}
            <div class="flex items-center gap-3">
              <i class="fas fa-phone text-gray-500 w-4"></i>
              <span class="text-gray-900 dark:text-white">{{ live_lecture.instructor_contact }}</span>
            </div>
            {% endif %}
            {% if live_lecture.instructor_email %}
            <div class="flex items-center gap-3">
              <i class="fas fa-envelope text-gray-500 w-4"></i>
              <a href="mailto:{{ live_lecture.instructor_email }}" 
                 class="text-blue-600 dark:text-blue-400 hover:underline">
                {{ live_lecture.instructor_email }}
              </a>
            </div>
            {% endif %}
            {% if live_lecture.instructor_chat_channel %}
            <div class="flex items-center gap-3">
              <i class="fas fa-comments text-gray-500 w-4"></i>
              <a href="{{ live_lecture.instructor_chat_channel }}" 
                 target="_blank" 
                 rel="noopener noreferrer"
                 class="text-blue-600 dark:text-blue-400 hover:underline">
                ì†Œí†µì±„ë„ ë°”ë¡œê°€ê¸°
                <i class="fas fa-external-link-alt text-xs ml-1"></i>
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}


      </div>

      <!-- ì˜¤ë¥¸ìª½: ë¼ì´ë¸Œ ê°•ì˜ ì •ë³´ -->
      <div class="space-y-4">
        <!-- ì œëª© -->
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ live_lecture.name }}</h1>
          {% if not live_lecture.is_active %}
          <span class="inline-block px-3 py-1 bg-gray-500 text-white text-sm rounded-full">ë¹„í™œì„±í™”</span>
          {% endif %}
        </div>

        <!-- ì¼ì‹œ ì •ë³´ -->
        {% if live_lecture.date_time %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-2">
            <i class="fas fa-calendar-alt text-purple-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì¼ì‹œ</h3>
          </div>
          <div class="text-xl font-medium text-gray-900 dark:text-white">
            {{ live_lecture.date_time|date:"Yë…„ mì›” dì¼ (l)" }}
          </div>
          <div class="text-lg text-gray-600 dark:text-gray-400">
            {{ live_lecture.date_time|date:"H:i" }}
          </div>
        </div>
        {% endif %}

        <!-- íŠ¹ì´ì‚¬í•­ -->
        {% if live_lecture.special_notes %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-exclamation-circle text-yellow-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">íŠ¹ì´ì‚¬í•­</h3>
          </div>
          <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
            <div class="text-sm text-yellow-800 dark:text-yellow-200">
              {{ live_lecture.special_notes }}
            </div>
          </div>
        </div>
        {% endif %}

        <!-- ê°€ê²© ì •ë³´ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-bitcoin-sign text-orange-500 text-lg"></i>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì°¸ê°€ë¹„</h3>
          </div>
          <div class="space-y-4">
            <!-- ë©”ì¸ ê°€ê²© -->
            <div>
              {% if live_lecture.price_display == 'free' %}
              <div class="text-3xl font-bold text-green-600 dark:text-green-400">
                ë¬´ë£Œ
              </div>
              {% elif live_lecture.is_discounted and live_lecture.is_early_bird_active %}
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl font-bold text-gray-900 dark:text-white">
                  {{ live_lecture.current_price|floatformat:0|intcomma }} sats
                </span>
                <span class="px-3 py-1 bg-red-500 text-white text-sm font-medium rounded-full">
                  {{ live_lecture.public_discount_rate }}% í• ì¸
                </span>
              </div>
              <div class="text-lg text-gray-500 line-through">
                {% if live_lecture.price_display == 'krw' %}
                  {{ live_lecture.public_price_krw|floatformat:0|intcomma }} sats
                {% else %}
                  {{ live_lecture.price|floatformat:0|intcomma }} sats
                {% endif %}
              </div>
                             <!-- ì›í™” ì—°ë™ ê°•ì˜ì¼ ë•Œ ì›í™” ê°€ê²©ë„ í‘œì‹œ -->
               {% if live_lecture.price_display == 'krw' %}
               <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                 <div class="flex items-center gap-2">
                   {% if live_lecture.is_discounted and live_lecture.is_early_bird_active %}
                   <span class="font-medium text-red-600 dark:text-red-400">{{ live_lecture.krw_discounted_price_display }}</span>
                   <span class="line-through">{{ live_lecture.krw_price_display }}</span>
                   {% else %}
                   <span class="font-medium">{{ live_lecture.krw_price_display }}</span>
                   {% endif %}
                   <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 px-2 py-1 rounded-full">ì›í™” ì—°ë™</span>
                 </div>
                 {% if live_lecture.current_exchange_rate %}
                 <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                   í™˜ìœ¨: 1 BTC = {{ live_lecture.current_exchange_rate.btc_krw_rate|floatformat:0|intcomma }}ì›
                   ({{ live_lecture.current_exchange_rate.created_at|date:"mì›” dì¼ H:i" }} ê¸°ì¤€)
                 </div>
                 {% endif %}
               </div>
               {% endif %}
              {% else %}
              <div class="text-3xl font-bold text-gray-900 dark:text-white">
                {{ live_lecture.current_price|floatformat:0|intcomma }} sats
              </div>
                             <!-- ì›í™” ì—°ë™ ê°•ì˜ì¼ ë•Œ ì›í™” ê°€ê²©ë„ í‘œì‹œ -->
               {% if live_lecture.price_display == 'krw' %}
               <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                 <div class="flex items-center gap-2">
                   <span class="font-medium">{{ live_lecture.krw_price_display }}</span>
                   <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 px-2 py-1 rounded-full">ì›í™” ì—°ë™</span>
                 </div>
                 {% if live_lecture.current_exchange_rate %}
                 <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                   í™˜ìœ¨: 1 BTC = {{ live_lecture.current_exchange_rate.btc_krw_rate|floatformat:0|intcomma }}ì›
                   ({{ live_lecture.current_exchange_rate.created_at|date:"mì›” dì¼ H:i" }} ê¸°ì¤€)
                 </div>
                 {% endif %}
               </div>
               {% endif %}
              {% endif %}
            </div>
          </div>
        </div>

        <!-- ì°¸ê°€ ì •ì› ì •ë³´ -->
        {% if not live_lecture.no_limit %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <i class="fas fa-users text-purple-500 text-lg"></i>
              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">ì°¸ê°€ ì •ì›</h4>
            </div>
            <div class="flex items-center gap-2">
              <i class="fas fa-user-friends text-sm text-gray-500"></i>
              <span class="text-sm font-medium {% if live_lecture.is_expired %}text-gray-500{% elif live_lecture.is_full %}text-red-500{% elif live_lecture.remaining_spots <= 5 and live_lecture.remaining_spots > 0 %}text-orange-500{% else %}text-green-500{% endif %}">
                {% if live_lecture.is_expired %}
                  ì¢…ë£Œ
                {% elif live_lecture.is_full %}
                  ì •ì› ë§ˆê°
                {% elif live_lecture.remaining_spots is not None %}
                  ë‚¨ì€ìë¦¬: {{ live_lecture.remaining_spots|intcomma }}ëª…
                {% else %}
                  ì°¸ê°€ ê°€ëŠ¥
                {% endif %}
              </span>
            </div>
          </div>
          
          <div class="space-y-2">
            <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
              <span>í˜„ì¬ ì°¸ê°€ì</span>
              <span>{{ live_lecture.current_participants|default:0 }}ëª… / {{ live_lecture.max_participants }}ëª…</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: {% widthratio live_lecture.current_participants|default:0 live_lecture.max_participants 100 %}%; max-width: 100%;"></div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
          <div class="flex items-center gap-3 mb-4">
            <i class="fas fa-infinity text-purple-500 text-lg"></i>
            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">ì°¸ê°€ ì •ì›</h4>
          </div>
          <div class="text-center text-gray-600 dark:text-gray-400">
            <i class="fas fa-users text-4xl mb-2"></i>
            <div>ì •ì› ì œí•œ ì—†ìŒ</div>
          </div>
        </div>
        {% endif %}

        <!-- ë””ë²„ê¹… ì •ë³´ (ê°œë°œìš©) -->
        {% if settings.DEBUG %}
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-4">
          <h4 class="font-bold text-yellow-800 dark:text-yellow-200 mb-2">ğŸ› ë””ë²„ê¹… ì •ë³´ (ê°œë°œ ëª¨ë“œ)</h4>
          <div class="text-xs text-yellow-700 dark:text-yellow-300 space-y-1">
            <div>is_active: {{ live_lecture.is_active }}</div>
            <div>is_temporarily_closed: {{ live_lecture.is_temporarily_closed }}</div>
            <div>is_expired: {{ live_lecture.is_expired }}</div>
            <div>is_full: {{ live_lecture.is_full }}</div>
            <div>can_participate: {{ live_lecture.can_participate }}</div>
            <div>current_participants: {{ live_lecture.current_participants }}</div>
            <div>max_participants: {{ live_lecture.max_participants }}</div>
            <div>date_time: {{ live_lecture.date_time }}</div>
            <div>í˜„ì¬ ì‹œê°„: {% now "Y-m-d H:i:s" %}</div>
          </div>
        </div>
        {% endif %}

        <!-- ì°¸ê°€ ì•ˆë‚´ ë°•ìŠ¤ -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 mb-4">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-info-circle text-blue-600 dark:text-blue-400 text-sm mt-1"></i>
            </div>
            <div class="ml-3">
              <p class="text-blue-800 dark:text-blue-200 text-sm">
                ì°¸ê°€ ì´ë©”ì¼ì€ ë°œì†¡ë˜ì§€ ì•Šìœ¼ë©°, ìƒì„¸í•œ ì‹ ì²­ ì •ë³´ëŠ” 
                <a href="{% url 'accounts:mypage' %}" class="font-semibold hover:underline">ë§ˆì´í˜ì´ì§€</a> â†’ 
                <a href="{% url 'accounts:my_live_lecture_orders' %}" class="font-semibold hover:underline">ë¼ì´ë¸Œ ê°•ì˜ ì‹ ì²­ë‚´ì—­</a> 
                ë©”ë‰´ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
          </div>
        </div>

        <!-- ì°¸ê°€ ì‹ ì²­ ë²„íŠ¼ -->
        <div class="space-y-3">
          {% if live_lecture.can_participate %}
            {% if user.is_authenticated %}
            <button class="w-full py-4 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-xl transition-colors shadow-lg hover:shadow-xl flex items-center justify-center gap-2" 
                    onclick="joinLiveLecture()">
              {% if live_lecture.price_display == 'free' %}
              <i class="fas fa-heart"></i>
              <span>ë¬´ë£Œ ì°¸ê°€ ì‹ ì²­í•˜ê¸°</span>
              {% else %}
              <i class="fas fa-video"></i>
              <span>ì°¸ê°€ ì‹ ì²­í•˜ê¸°</span>
              {% endif %}
            </button>
            <!-- íšŒì› ì°¸ê°€ ê°€ëŠ¥ ì•ˆë‚´ -->
            <div class="text-center">
              <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                <i class="fas fa-user-check mr-1"></i>íšŒì› ë¡œê·¸ì¸ ì™„ë£Œ
              </span>
            </div>
            {% else %}
            <a href="{% url 'accounts:lightning_login' %}?next={% url 'lecture:live_lecture_detail' store.store_id live_lecture.id %}" 
               class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl transition-colors shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
              <i class="fas fa-bolt"></i>
              <span>ë¼ì´íŠ¸ë‹ ë¡œê·¸ì¸ í›„ ì°¸ê°€ ì‹ ì²­í•˜ê¸°</span>
            </a>
            <!-- ë¡œê·¸ì¸ í•„ìš” ì•ˆë‚´ -->
            <div class="text-center">
              <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full">
                <i class="fas fa-lock mr-1"></i>íšŒì›ë§Œ ì°¸ê°€ ê°€ëŠ¥
              </span>
            </div>
            {% endif %}
          {% elif live_lecture.is_expired %}
          <button class="w-full py-4 bg-gray-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-calendar-times"></i>
            <span>ê°•ì˜ ì¢…ë£Œ</span>
          </button>
          <div class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4">
            <div class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
              <i class="fas fa-info-circle text-gray-500"></i>
              <span class="text-sm">ì´ë¯¸ ì¢…ë£Œëœ ê°•ì˜ì…ë‹ˆë‹¤. ë‹¤ìŒ ê°•ì˜ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!</span>
            </div>
          </div>
          {% elif live_lecture.is_full %}
          <button class="w-full py-4 bg-red-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-users-slash"></i>
            <span>ì •ì›ë§ˆê°</span>
          </button>
          {% else %}
          <button class="w-full py-4 bg-gray-400 text-white font-semibold rounded-xl cursor-not-allowed flex items-center justify-center gap-2" 
                  disabled>
            <i class="fas fa-exclamation-triangle"></i>
            <span>ì°¸ê°€ ë¶ˆê°€</span>
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ë¼ì´ë¸Œ ê°•ì˜ ì •ë³´ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬ -->
<script type="application/json" id="live-lecture-data">
{
  "priceType": "{{ live_lecture.price_display }}",
  "satoshiPrice": {{ live_lecture.price|default:0 }},
  "krwPrice": {{ live_lecture.price_krw|default:0 }},
  "currentSatoshiPrice": {{ live_lecture.current_price|default:0 }},
  "lectureId": {{ live_lecture.id }},
  "storeId": "{{ store.store_id }}",
  "isAuthenticated": {{ user.is_authenticated|yesno:"true,false" }},
  "isStoreOwner": {% if user == store.owner %}true{% else %}false{% endif %},
  "loginUrl": "{% url 'accounts:login' %}",
  "csrfToken": "{{ csrf_token }}"
}
</script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- Markdown Renderer -->
<script src="{% static 'js/markdown-renderer.js' %}"></script>
<script>
function joinLiveLecture() {
  console.log('joinLiveLecture í•¨ìˆ˜ í˜¸ì¶œë¨'); // ë””ë²„ê¹…
  
  const data = JSON.parse(document.getElementById('live-lecture-data').textContent);
  console.log('ë¼ì´ë¸Œ ê°•ì˜ ë°ì´í„°:', data); // ë””ë²„ê¹…
  
  if (!data.isAuthenticated) {
    console.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™'); // ë””ë²„ê¹…
    window.location.href = data.loginUrl;
    return;
  }
  
  console.log('ì²´í¬ì•„ì›ƒ í˜ì´ì§€ë¡œ ì´ë™ ì‹œë„'); // ë””ë²„ê¹…
  
  // ë¬´ë£Œ/ìœ ë£Œ ê°•ì˜ ëª¨ë‘ checkout í˜ì´ì§€ë¡œ ì´ë™ (ë·°ì—ì„œ ì²˜ë¦¬)
  const checkoutUrl = `/lecture/${data.storeId}/live/${data.lectureId}/checkout/`;
  console.log('ì²´í¬ì•„ì›ƒ URL:', checkoutUrl); // ë””ë²„ê¹…
  
  window.location.href = checkoutUrl;
}



// ë§ˆí¬ë‹¤ìš´ ë Œë”ë§
document.addEventListener('DOMContentLoaded', function() {
  const markdownElements = document.querySelectorAll('.markdown-content');
  markdownElements.forEach(element => {
    const markdownText = element.getAttribute('data-markdown');
    if (markdownText && typeof marked !== 'undefined') {
      element.innerHTML = marked.parse(markdownText);
    }
  });
});
</script>
{% endblock %} 
