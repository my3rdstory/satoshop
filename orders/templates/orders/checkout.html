{% extends 'stores/store_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}ì£¼ë¬¸í•˜ê¸°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .status-pending {
    @apply bg-yellow-50 border-yellow-200 text-yellow-800 dark:bg-yellow-900/20 dark:border-yellow-800 dark:text-yellow-200;
  }

  .status-success {
    @apply bg-green-50 border-green-200 text-green-800 dark:bg-green-900/20 dark:border-green-800 dark:text-green-200;
  }

  .status-error {
    @apply bg-red-50 border-red-200 text-red-800 dark:bg-red-900/20 dark:border-red-800 dark:text-red-200;
  }

  .invoice-btn {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .invoice-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
  }
</style>
{% endblock %}

{% block store_content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="flex items-center justify-center mb-8">
      <div class="p-2 bg-bitcoin/10 rounded-full mr-3">
        <i class="fas fa-shopping-cart text-3xl text-bitcoin"></i>
      </div>
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ì£¼ë¬¸í•˜ê¸°</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">ì£¼ë¬¸ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”</p>
      </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
      <!-- ì™¼ìª½: ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡ (2/3 ë„ˆë¹„) -->
      <div class="xl:col-span-2">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
          <!-- í—¤ë” -->
          <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-6">
            <div class="flex items-center">
              <i class="fas fa-shopping-cart text-xl mr-3"></i>
              <h2 class="text-xl font-bold">ì£¼ë¬¸ ìƒí’ˆ ({{ cart.total_items }}ê°œ)</h2>
            </div>
          </div>

          <!-- ìƒí’ˆ ëª©ë¡ -->
          <div class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for store_data in stores_with_items %}
            <div class="p-0">
              <!-- ìŠ¤í† ì–´ í—¤ë” -->
              <div class="bg-gray-100 dark:bg-gray-700 px-6 py-4 border-b border-gray-200 dark:border-gray-600">
                <div class="flex items-center">
                  <i class="fas fa-store text-gray-600 dark:text-gray-400 mr-3"></i>
                  <span class="font-semibold text-gray-900 dark:text-white">{{ store_data.store.store_name }}</span>
                </div>
              </div>

              <!-- ìƒí’ˆë“¤ -->
              {% for item in store_data.items %}
              <div class="p-6 flex gap-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                <div class="flex-shrink-0">
                  <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-xl overflow-hidden flex items-center justify-center">
                    {% if item.product.images.first %}
                    <img src="{{ item.product.images.first.file_url }}" alt="{{ item.product.title }}" class="w-full h-full object-cover">
                    {% else %}
                    <i class="fas fa-image text-2xl text-gray-400"></i>
                    {% endif %}
                  </div>
                </div>

                <!-- ìƒí’ˆ ì •ë³´ -->
                <div class="flex-1 min-w-0">
                  <h3 class="font-semibold text-gray-900 dark:text-white text-lg mb-2">{{ item.product.title }}</h3>
                  
                  {% if item.options_display %}
                  <div class="flex flex-wrap gap-2 mb-3">
                    {% for option in item.options_display %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200">
                      {{ option.option_name }}: {{ option.choice_name }}{% if option.choice_price > 0 %} (+{{ option.choice_price|floatformat:0|intcomma }}sats){% endif %}
                    </span>
                    {% endfor %}
                  </div>
                  {% endif %}

                  <div class="flex justify-between items-center">
                    <span class="text-gray-600 dark:text-gray-400">ìˆ˜ëŸ‰: {{ item.quantity }}ê°œ</span>
                    <span class="font-bold text-lg text-bitcoin">{{ item.total_price|floatformat:0|intcomma }} sats</span>
                  </div>
                </div>
              </div>
              {% endfor %}

              <!-- ìŠ¤í† ì–´ ì†Œê³„ -->
              <div class="bg-gray-50 dark:bg-gray-700/50 px-6 py-4 border-t border-gray-200 dark:border-gray-600">
                <div class="flex justify-between items-center">
                  <div class="text-gray-700 dark:text-gray-300">
                    <span class="font-medium">{{ store_data.store.store_name }}</span> - 
                    ìƒí’ˆ ì†Œê³„: <span class="font-semibold">{{ store_data.subtotal|floatformat:0|intcomma }} sats</span> + 
                    ë°°ì†¡ë¹„: 
                    {% if store_data.shipping_fee == 0 %}
                      <span class="text-green-600 dark:text-green-400 font-semibold">ë¬´ë£Œ</span>
                    {% else %}
                      <span class="font-semibold">{{ store_data.shipping_fee|floatformat:0|intcomma }} sats</span>
                    {% endif %}
                  </div>
                  <span class="font-bold text-xl text-bitcoin">
                    {{ store_data.total|floatformat:0|intcomma }} sats
                  </span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <!-- ì¤‘ìš” ì•ˆë‚´ì‚¬í•­ -->
        <div class="mt-6 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-2xl shadow-lg overflow-hidden">
          <div class="bg-red-600 text-white p-4">
            <div class="flex items-center">
              <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
              <h3 class="text-lg font-bold">âš ï¸ ì¤‘ìš” ì•ˆë‚´ì‚¬í•­</h3>
            </div>
          </div>
          <div class="p-6">
            <div class="flex items-start space-x-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                  <i class="fas fa-download text-red-600 dark:text-red-400 text-lg"></i>
                </div>
              </div>
              <div class="flex-1">
                <h4 class="font-bold text-red-900 dark:text-red-100 text-3xl mb-2">
                  ê²°ì œ í›„ ì£¼ë¬¸ì„œ ë‹¤ìš´ë¡œë“œ í•„ìˆ˜
                </h4>
                <p class="text-red-800 dark:text-red-200 font-medium leading-relaxed">
                  <span class="bg-red-200 dark:bg-red-800 px-2 py-1 rounded font-bold">ì£¼ë¬¸ ì •ë³´ëŠ” ë³„ë„ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span><br>
                  ê²°ì œ ì™„ë£Œ í›„ ë‚˜íƒ€ë‚˜ëŠ” <strong>ì£¼ë¬¸ì„œë¥¼ ë°˜ë“œì‹œ ë‹¤ìš´ë¡œë“œ</strong> ë°›ì•„ ë³´ê´€í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
                </p>
                <div class="mt-4 p-3 bg-red-100 dark:bg-red-900/40 rounded-lg">
                  <div class="text-sm text-red-700 dark:text-red-300">
                    <div class="font-semibold mb-1">ğŸ’¡ ì£¼ë¬¸ì„œì— í¬í•¨ëœ ì •ë³´:</div>
                    <ul class="list-disc list-inside space-y-1 ml-2">
                      <li>ì£¼ë¬¸ ë²ˆí˜¸ ë° ê²°ì œ ì •ë³´</li>
                      <li>êµ¬ë§¤ ìƒí’ˆ ìƒì„¸ ë‚´ì—­</li>
                      <li>ë°°ì†¡ì§€ ì •ë³´</li>
                      <li>íŒë§¤ì ì—°ë½ì²˜</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½: ê²°ì œ ì •ë³´ (1/3 ë„ˆë¹„) -->
      <div class="xl:col-span-1">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden sticky top-8">
          <!-- í—¤ë” -->
          <div class="bg-gradient-to-r from-green-600 to-green-800 text-white p-6">
            <div class="flex items-center">
              <i class="fas fa-credit-card text-xl mr-3"></i>
              <h2 class="text-xl font-bold">ê²°ì œ ì •ë³´</h2>
            </div>
          </div>

          <div class="p-6 space-y-6">
            <!-- ì´ì•¡ ìš”ì•½ -->
            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 border border-gray-200 dark:border-gray-600">
              <div class="space-y-3">
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600 dark:text-gray-400">ìƒí’ˆ ì´ì•¡</span>
                  <span class="font-semibold text-bitcoin">{{ subtotal_amount|floatformat:0|intcomma }} sats</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600 dark:text-gray-400">ë°°ì†¡ë¹„</span>
                  <span class="font-semibold text-bitcoin">
                    {% if total_shipping_fee == 0 %}
                      ë¬´ë£Œ
                    {% else %}
                      {{ total_shipping_fee|floatformat:0|intcomma }} sats
                    {% endif %}
                  </span>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-600 pt-3">
                  <div class="flex justify-between">
                    <span class="font-bold text-gray-900 dark:text-white">ìµœì¢… ê²°ì œê¸ˆì•¡</span>
                    <span class="font-bold text-xl text-bitcoin">{{ total_amount|floatformat:0|intcomma }} sats</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- í™˜ìœ¨ ê³ ì • ì•ˆë‚´ (ì›í™” ì—°ë™ ìƒí’ˆì´ ìˆì„ ë•Œë§Œ) -->
            {% if has_krw_products %}
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-4 border border-blue-200 dark:border-blue-700">
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <div class="w-10 h-10 bg-blue-100 dark:bg-blue-800 rounded-full flex items-center justify-center">
                    <i class="fas fa-lock text-blue-600 dark:text-blue-400"></i>
                  </div>
                </div>
                <div class="ml-3">
                  <h3 class="font-semibold text-gray-900 dark:text-white mb-1 flex items-center">
                    <i class="fas fa-won-sign text-blue-600 dark:text-blue-400 mr-1 text-sm"></i>
                    <span class="text-sm">ê°€ê²© ê³ ì • ì ìš©ë¨</span>
                  </h3>
                  <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">
                    <p class="flex items-start">
                      <i class="fas fa-check-circle text-green-500 mr-1 mt-0.5 text-xs"></i>
                      <span>ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹œì ì˜ í™˜ìœ¨ë¡œ ê°€ê²©ì´ <strong class="text-green-600">ê³ ì •</strong>ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                    </p>
                    <p class="flex items-start">
                      <i class="fas fa-shield-alt text-blue-500 mr-1 mt-0.5 text-xs"></i>
                      <span>í™˜ìœ¨ ë³€ë™ê³¼ ë¬´ê´€í•˜ê²Œ <strong class="text-blue-600">ì•ˆì •ì ì¸ ê²°ì œ</strong>ê°€ ì§„í–‰ë©ë‹ˆë‹¤.</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- ë°°ì†¡ ì •ë³´ -->
            {% if shipping_data %}
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4">
              <div class="flex items-center mb-4">
                <i class="fas fa-truck text-blue-600 dark:text-blue-400 mr-2"></i>
                <h3 class="font-bold text-blue-900 dark:text-blue-100">ë°°ì†¡ ì •ë³´</h3>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex">
                  <span class="font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0">ì£¼ë¬¸ì:</span>
                  <span class="text-gray-900 dark:text-white">{{ shipping_data.buyer_name }}</span>
                </div>
                <div class="flex">
                  <span class="font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0">ì—°ë½ì²˜:</span>
                  <span class="text-gray-900 dark:text-white">{{ shipping_data.buyer_phone }}</span>
                </div>
                <div class="flex">
                  <span class="font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0">ì´ë©”ì¼:</span>
                  <span class="text-gray-900 dark:text-white">{{ shipping_data.buyer_email }}</span>
                </div>
                <div class="flex">
                  <span class="font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0">ë°°ì†¡ì§€:</span>
                  <span class="text-gray-900 dark:text-white">
                    ({{ shipping_data.shipping_postal_code }}) {{ shipping_data.shipping_address }}
                    {% if shipping_data.shipping_detail_address %}
                      <br>{{ shipping_data.shipping_detail_address }}
                    {% endif %}
                  </span>
                </div>
                {% if shipping_data.order_memo %}
                <div class="flex">
                  <span class="font-medium text-gray-700 dark:text-gray-300 w-16 flex-shrink-0">ìš”ì²­ì‚¬í•­:</span>
                  <span class="text-gray-900 dark:text-white">{{ shipping_data.order_memo }}</span>
                </div>
                {% endif %}
              </div>
              
              <div class="mt-4 pt-3 border-t border-blue-200 dark:border-blue-700">
                <a href="{% url 'orders:shipping_info' %}" class="inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 text-sm font-medium transition-colors">
                  <i class="fas fa-edit mr-2"></i>
                  ë°°ì†¡ ì •ë³´ ìˆ˜ì •
                </a>
              </div>
            </div>
            {% endif %}

            <!-- ê²°ì œ ë°©ë²• ì•ˆë‚´ -->
            <div class="space-y-4">
              <div class="flex items-center">
                <i class="fas fa-bolt text-bitcoin mr-2"></i>
                <h3 class="font-bold text-gray-900 dark:text-white">ê²°ì œ ë°©ë²•</h3>
              </div>
              
              <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                <div class="flex items-center mb-2">
                  <i class="fas fa-bolt text-yellow-600 dark:text-yellow-400 mr-2"></i>
                  <span class="font-semibold text-yellow-800 dark:text-yellow-200">ë¼ì´íŠ¸ë‹ ë„¤íŠ¸ì›Œí¬ ê²°ì œ</span>
                </div>
                <p class="text-sm text-yellow-700 dark:text-yellow-300">ë¹ ë¥´ê³  ì €ë ´í•œ ë¹„íŠ¸ì½”ì¸ ê²°ì œë¥¼ ì§€ì›í•©ë‹ˆë‹¤</p>
              </div>

              <div class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                <p class="font-medium text-gray-900 dark:text-white">ê²°ì œ ì§„í–‰ ë°©ë²•:</p>
                <ol class="list-decimal list-inside space-y-1 ml-2">
                  <li>ì•„ë˜ "ê²°ì œ ì¸ë³´ì´ìŠ¤ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­</li>
                  <li>ìƒì„±ëœ QR ì½”ë“œë¥¼ ë¼ì´íŠ¸ë‹ ì§€ê°‘ìœ¼ë¡œ ìŠ¤ìº”</li>
                  <li>ê²°ì œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì£¼ë¬¸ì´ í™•ì •ë©ë‹ˆë‹¤</li>
                </ol>
                
                <p class="mt-3">
                  <span class="font-medium text-gray-900 dark:text-white">ì§€ì› ì§€ê°‘:</span> ìŠ¤íŠ¸ë¼ì´í¬, ì›”ë › ì˜¤ë¸Œ ì‚¬í† ì‹œ, í”¼ë‹‰ìŠ¤, ìŠ¤í”¼ë“œ, ë¸”ë§í¬ ë“±
                </p>
              </div>
            </div>

            <!-- ì¸ë³´ì´ìŠ¤ ìƒì„± ë²„íŠ¼ -->
            <button 
              class="invoice-btn w-full text-white py-4 px-6 rounded-xl font-bold text-lg flex items-center justify-center transition-all duration-300 hover:shadow-lg" 
              onclick="generateInvoice()" 
              id="generateInvoiceBtn"
            >
              <i class="fas fa-qrcode mr-3"></i>
              ê²°ì œ ì¸ë³´ì´ìŠ¤ ìƒì„±
            </button>

            <!-- QR ì½”ë“œ ë° ì¸ë³´ì´ìŠ¤ í‘œì‹œ ì˜ì—­ -->
            <div id="invoiceContainer" class="hidden space-y-4">
              <!-- QR ì½”ë“œ -->
              <div class="text-center">
                <div id="qrCodeContainer" class="inline-block p-5 bg-white dark:bg-gray-700 rounded-xl shadow-lg border border-gray-200 dark:border-gray-600">
                  <img id="qrCodeImage" src="" alt="ê²°ì œ QR ì½”ë“œ" class="max-w-[250px] hidden">
                  <div id="loadingSpinner" class="hidden">
                    <div class="w-10 h-10 border-4 border-gray-300 border-t-bitcoin rounded-full animate-spin mx-auto"></div>
                    <p class="mt-3 text-gray-600 dark:text-gray-400">ì¸ë³´ì´ìŠ¤ ìƒì„± ì¤‘...</p>
                  </div>
                </div>
              </div>

              <!-- ì¸ë³´ì´ìŠ¤ í…ìŠ¤íŠ¸ -->
              <div>
                <label class="block font-semibold mb-2 text-gray-900 dark:text-white">ë¼ì´íŠ¸ë‹ ì¸ë³´ì´ìŠ¤</label>
                <textarea 
                  id="invoiceTextArea" 
                  readonly 
                  class="w-full h-32 font-mono text-sm p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                  placeholder="ì¸ë³´ì´ìŠ¤ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."
                ></textarea>
                <button 
                  type="button" 
                  onclick="copyInvoiceToClipboard()" 
                  class="mt-2 text-bitcoin hover:text-bitcoin/80 text-sm font-medium transition-colors"
                >
                  <i class="fas fa-copy mr-1"></i> ì¸ë³´ì´ìŠ¤ ë³µì‚¬
                </button>
              </div>

              <!-- ê²°ì œ ìƒíƒœ -->
              <div id="paymentStatus" class="hidden p-4 rounded-lg border">
                <div id="paymentMessage"></div>
              </div>

              <!-- ì·¨ì†Œ ë²„íŠ¼ -->
              <div id="cancelContainer" class="hidden">
                <button 
                  type="button" 
                  onclick="cancelInvoice()" 
                  id="cancelInvoiceBtn" 
                  class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition-colors"
                >
                  <i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ
                </button>
              </div>

              <!-- ê²°ì œ ì•ˆë‚´ -->
              <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 text-sm">
                <p class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">
                  <i class="fas fa-bolt mr-1"></i> ê²°ì œ ë°©ë²•:
                </p>
                <ol class="list-decimal list-inside space-y-1 text-yellow-700 dark:text-yellow-300 ml-2">
                  <li>QR ì½”ë“œë¥¼ ë¼ì´íŠ¸ë‹ ì§€ê°‘ìœ¼ë¡œ ìŠ¤ìº”í•˜ê±°ë‚˜</li>
                  <li>ì¸ë³´ì´ìŠ¤ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ì§€ê°‘ì— ë¶™ì—¬ë„£ê¸°</li>
                  <li>ê²°ì œ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì£¼ë¬¸ì´ í™•ì •ë©ë‹ˆë‹¤</li>
                </ol>
                <p class="mt-2 text-yellow-700 dark:text-yellow-300">
                  <span class="font-semibold">ì§€ì› ì§€ê°‘:</span> Phoenix, Wallet of Satoshi, Blue Wallet, Muun ë“±
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
<script src="{% static 'js/common.js' %}"></script>
<script>
let currentPaymentHash = null;
let currentInvoice = null;
let paymentCheckInterval = null;

function generateInvoice() {
  const generateBtn = document.getElementById('generateInvoiceBtn');
  const invoiceContainer = document.getElementById('invoiceContainer');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const qrCodeImage = document.getElementById('qrCodeImage');
  
  // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
  generateBtn.disabled = true;
  generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i> ìƒì„± ì¤‘...';
  
  // ì·¨ì†Œ ë²„íŠ¼ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
  document.getElementById('cancelContainer').classList.add('hidden');
  const cancelBtn = document.getElementById('cancelInvoiceBtn');
  cancelBtn.disabled = false;
  cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ';
  
  // ê¸°ì¡´ ê²°ì œ ìƒíƒœ í™•ì¸ ì¤‘ì§€
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
    paymentCheckInterval = null;
  }
  
  // ì¸ë³´ì´ìŠ¤ ì»¨í…Œì´ë„ˆ í‘œì‹œ ë° ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
  invoiceContainer.classList.remove('hidden');
  loadingSpinner.classList.remove('hidden');
  qrCodeImage.classList.add('hidden');
  
  // ì¸ë³´ì´ìŠ¤ ìƒì„± ìš”ì²­
  fetch('/orders/checkout/create_invoice/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ì¸ë³´ì´ìŠ¤ ìƒì„± ì„±ê³µ
      currentPaymentHash = data.payment_hash;
      currentInvoice = data.invoice;
      
      // QR ì½”ë“œ ìƒì„±
      generateQRCode(data.invoice);
      
      // ì¸ë³´ì´ìŠ¤ í…ìŠ¤íŠ¸ í‘œì‹œ
      document.getElementById('invoiceTextArea').value = data.invoice;
      
      // ë¡œë”© ìˆ¨ê¸°ê³  QR ì½”ë“œ í‘œì‹œ
      loadingSpinner.classList.add('hidden');
      qrCodeImage.classList.remove('hidden');
      
      // ê²°ì œ ìƒíƒœ í™•ì¸ ì‹œì‘
      startPaymentStatusCheck();
      
      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
      showPaymentStatus('ê²°ì œë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì¸ë³´ì´ìŠ¤ë¥¼ ë³µì‚¬í•˜ì—¬ ê²°ì œí•´ì£¼ì„¸ìš”.', 'pending');
      
      // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
      generateBtn.innerHTML = '<i class="fas fa-check mr-3"></i> ì¸ë³´ì´ìŠ¤ ìƒì„±ë¨';
      
      // ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
      document.getElementById('cancelContainer').classList.remove('hidden');
      
    } else {
      // ì¸ë³´ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨
      showPaymentStatus('ì¸ë³´ì´ìŠ¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error, 'error');
      
      // ë²„íŠ¼ ë³µì›
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-qrcode mr-3"></i> ê²°ì œ ì¸ë³´ì´ìŠ¤ ìƒì„±';
      
      // ë¡œë”© ìˆ¨ê¸°ê¸°
      loadingSpinner.classList.add('hidden');
      
      // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
      document.getElementById('cancelContainer').classList.add('hidden');
      const cancelBtn = document.getElementById('cancelInvoiceBtn');
      cancelBtn.disabled = false;
      cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showPaymentStatus('ì¸ë³´ì´ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    
    // ë²„íŠ¼ ë³µì›
    generateBtn.disabled = false;
    generateBtn.innerHTML = '<i class="fas fa-qrcode mr-3"></i> ê²°ì œ ì¸ë³´ì´ìŠ¤ ìƒì„±';
    
    // ë¡œë”© ìˆ¨ê¸°ê¸°
    loadingSpinner.classList.add('hidden');
    
    // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
    document.getElementById('cancelContainer').classList.add('hidden');
    const cancelBtn = document.getElementById('cancelInvoiceBtn');
    cancelBtn.disabled = false;
    cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ';
  });
}

function generateQRCode(invoice) {
  try {
    const qr = new QRious({
      element: document.getElementById('qrCodeImage'),
      value: invoice,
      size: 250,
      level: 'M'
    });
  } catch (error) {
    console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
    // QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ í…ìŠ¤íŠ¸ í‘œì‹œ
    document.getElementById('qrCodeImage').alt = 'QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨';
  }
}

function copyInvoiceToClipboard() {
  if (currentInvoice) {
    const tempInput = document.createElement('input');
    tempInput.value = currentInvoice;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    
    // ë³µì‚¬ ì™„ë£Œ ë©”ì‹œì§€
    showPaymentStatus('ì¸ë³´ì´ìŠ¤ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    setTimeout(() => {
      showPaymentStatus('ê²°ì œë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ê±°ë‚˜ ì¸ë³´ì´ìŠ¤ë¥¼ ë³µì‚¬í•˜ì—¬ ê²°ì œí•´ì£¼ì„¸ìš”.', 'pending');
    }, 2000);
  }
}

function startPaymentStatusCheck() {
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
  }
  
  paymentCheckInterval = setInterval(checkPaymentStatus, 3000); // 3ì´ˆë§ˆë‹¤ í™•ì¸
}

function checkPaymentStatus() {
  if (!currentPaymentHash) return;
  
  fetch('/orders/checkout/check_payment/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      payment_hash: currentPaymentHash
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if (data.paid) {
        // ê²°ì œ ì™„ë£Œ
        clearInterval(paymentCheckInterval);
        showPaymentStatus('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');
        
        // 2ì´ˆ í›„ ì£¼ë¬¸ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.location.href = data.redirect_url;
        }, 2000);
      }
      // ê²°ì œ ëŒ€ê¸° ì¤‘ì´ë©´ ê³„ì† í™•ì¸
    } else {
      console.error('ê²°ì œ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', data.error);
    }
  })
  .catch(error => {
    console.error('ê²°ì œ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
  });
}

function showPaymentStatus(message, type) {
  const statusDiv = document.getElementById('paymentStatus');
  const messageDiv = document.getElementById('paymentMessage');
  
  statusDiv.className = 'status-' + type + ' p-4 rounded-lg border';
  statusDiv.classList.remove('hidden');
  messageDiv.innerHTML = message;
}

function cancelInvoice() {
  if (!currentPaymentHash) {
    showPaymentStatus('ì·¨ì†Œí•  ì¸ë³´ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
    return;
  }
  
  if (!confirm('ì •ë§ë¡œ ê²°ì œë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }
  
  const cancelBtn = document.getElementById('cancelInvoiceBtn');
  cancelBtn.disabled = true;
  cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ì·¨ì†Œ ì¤‘...';
  
  fetch('/orders/checkout/cancel_invoice/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify({
      payment_hash: currentPaymentHash
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // ê²°ì œ ìƒíƒœ í™•ì¸ ì¤‘ì§€
      if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
        paymentCheckInterval = null;
      }
      
      // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
      showPaymentStatus('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
      
      // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
      document.getElementById('cancelContainer').classList.add('hidden');
      
      // ì¸ë³´ì´ìŠ¤ ìƒì„± ë²„íŠ¼ ë³µì›
      const generateBtn = document.getElementById('generateInvoiceBtn');
      generateBtn.disabled = false;
      generateBtn.innerHTML = '<i class="fas fa-qrcode mr-3"></i> ê²°ì œ ì¸ë³´ì´ìŠ¤ ìƒì„±';
      
      // ì¸ë³´ì´ìŠ¤ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
      document.getElementById('invoiceContainer').classList.add('hidden');
      
      // í˜„ì¬ ì¸ë³´ì´ìŠ¤ ì •ë³´ ì´ˆê¸°í™”
      currentPaymentHash = null;
      currentInvoice = null;
      
    } else {
      // ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
      showPaymentStatus('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.error, 'error');
      
      // ì·¨ì†Œ ë²„íŠ¼ ë³µì›
      cancelBtn.disabled = false;
      cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ';
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showPaymentStatus('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    
    // ì·¨ì†Œ ë²„íŠ¼ ë³µì›
    cancelBtn.disabled = false;
    cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i> ê²°ì œ ì·¨ì†Œ';
  });
}

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¸í„°ë²Œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
  if (paymentCheckInterval) {
    clearInterval(paymentCheckInterval);
  }
});
</script>
{% endblock %} 