{% extends 'stores/store_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ store.store_name }} - 결제 정보 확인{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<style>
  .stats-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  }
  .dark .stats-card {
    background: linear-gradient(135deg, #1f2937 0%, #0f172a 100%);
  }
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.75rem;
  }
</style>
{% endblock %}

{% block store_content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-8">
  <div class="w-full px-4 sm:px-6 lg:px-12">
    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-10">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-bitcoin/10 rounded-full">
          <i class="fas fa-receipt text-3xl text-bitcoin"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">결제 정보 확인</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Blink 결제 트랜잭션의 단계별 상태를 확인하고 고객 문의에 대응하세요.</p>
        </div>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        <span class="block">총 {{ summary.total }}건 모니터링 중</span>
        <span class="block">마지막 갱신 {% now "Y-m-d H:i" %}</span>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
      <article class="stats-card rounded-2xl p-5 shadow-lg border border-gray-200 dark:border-gray-700 text-center">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">총 트랜잭션</p>
        <p class="text-3xl font-extrabold text-gray-900 dark:text-white mt-2">{{ summary.total }}</p>
      </article>
      <article class="stats-card rounded-2xl p-5 shadow-lg border border-gray-200 dark:border-gray-700 text-center">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">대기</p>
        <p class="text-3xl font-extrabold text-blue-500 mt-2">{{ summary.pending }}</p>
      </article>
      <article class="stats-card rounded-2xl p-5 shadow-lg border border-gray-200 dark:border-gray-700 text-center">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">진행 중</p>
        <p class="text-3xl font-extrabold text-amber-500 mt-2">{{ summary.processing }}</p>
      </article>
      <article class="stats-card rounded-2xl p-5 shadow-lg border border-gray-200 dark:border-gray-700 text-center">
        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">완료</p>
        <p class="text-3xl font-extrabold text-green-500 mt-2">{{ summary.completed }}</p>
      </article>
    </section>

    <form method="get" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-lg px-6 py-5 mb-8">
      <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div class="flex-1">
          <label for="status" class="block text-sm font-medium text-gray-700 dark:text-gray-300">상태</label>
          <select id="status" name="status" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 focus:border-bitcoin focus:ring-bitcoin">
            <option value="">전체</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>대기</option>
            <option value="processing" {% if status_filter == 'processing' %}selected{% endif %}>진행 중</option>
            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>완료</option>
            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>실패</option>
          </select>
        </div>
        <div class="flex-1">
          <label for="stage" class="block text-sm font-medium text-gray-700 dark:text-gray-300">현재 단계</label>
          <select id="stage" name="stage" class="mt-1 block w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-100 focus:border-bitcoin focus:ring-bitcoin">
            <option value="">전체</option>
            <option value="1" {% if stage_filter == '1' %}selected{% endif %}>1단계 - 결제 준비</option>
            <option value="2" {% if stage_filter == '2' %}selected{% endif %}>2단계 - 인보이스</option>
            <option value="3" {% if stage_filter == '3' %}selected{% endif %}>3단계 - 결제 확인</option>
            <option value="4" {% if stage_filter == '4' %}selected{% endif %}>4단계 - 입금 확인</option>
            <option value="5" {% if stage_filter == '5' %}selected{% endif %}>5단계 - 주문 저장</option>
          </select>
        </div>
        <div>
          <button type="submit" class="px-5 py-2.5 rounded-lg bg-bitcoin text-white font-semibold hover:bg-[#e08113] transition">필터 적용</button>
        </div>
      </div>
    </form>

    <section class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-lg">
      <header class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100">트랜잭션 목록</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">총 {{ transactions|length }}건</p>
      </header>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr class="text-left text-xs font-semibold uppercase tracking-wider text-gray-600 dark:text-gray-400">
              <th class="px-6 py-3">생성 시각</th>
              <th class="px-6 py-3">금액</th>
              <th class="px-6 py-3">상태</th>
              <th class="px-6 py-3">현재 단계</th>
              <th class="px-6 py-3">주문</th>
              <th class="px-6 py-3">사용자</th>
              <th class="px-6 py-3">결제 해시</th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-100 dark:divide-gray-700 text-sm text-gray-800 dark:text-gray-200">
            {% for transaction in transactions %}
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-900/60 transition">
              <td class="px-6 py-4 whitespace-nowrap">{{ transaction.created_at|date:"Y-m-d H:i" }}</td>
              <td class="px-6 py-4 whitespace-nowrap font-semibold text-bitcoin">{{ transaction.amount_sats|floatformat:0|intcomma }} sats</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if transaction.status == 'completed' %}
                <span class="status-badge bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300"><i class="fas fa-check-circle"></i>완료</span>
                {% elif transaction.status == 'failed' %}
                <span class="status-badge bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"><i class="fas fa-times-circle"></i>실패</span>
                {% elif transaction.status == 'processing' %}
                <span class="status-badge bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300"><i class="fas fa-spinner fa-spin"></i>진행 중</span>
                {% else %}
                <span class="status-badge bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"><i class="fas fa-hourglass-half"></i>대기</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ transaction.id }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">{{ transaction.payment_hash|default:'-' }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">{{ transaction.current_stage }} 단계</td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if transaction.order %}
                <a href="{% url 'orders:checkout_complete' transaction.order.order_number %}" class="text-bitcoin underline">{{ transaction.order.order_number }}</a>
                {% else %}
                <span class="text-gray-400">-</span>
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                {% if transaction.user %}
                  {{ transaction.user.username }}
                {% else %}
                  게스트
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">결제 트랜잭션이 없습니다.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if transactions.has_other_pages %}
      <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 text-sm text-gray-600 dark:text-gray-400">
        <div>
          총 {{ paginator.count }}건 중 {{ transactions.start_index }}-{{ transactions.end_index }} 표시
        </div>
        <nav class="flex items-center gap-2" aria-label="결제 트랜잭션 페이지네이션">
          {% if transactions.has_previous %}
          <a href="?page={{ transactions.previous_page_number }}&status={{ status_filter }}&stage={{ stage_filter }}" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">이전</a>
          {% else %}
          <span class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-400">이전</span>
          {% endif %}

          <span class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100">
            {{ transactions.number }} / {{ paginator.num_pages }}
          </span>

          {% if transactions.has_next %}
          <a href="?page={{ transactions.next_page_number }}&status={{ status_filter }}&stage={{ stage_filter }}" class="px-3 py-1 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition">다음</a>
          {% else %}
          <span class="px-3 py-1 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-400">다음</span>
          {% endif %}
        </nav>
      </div>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}
