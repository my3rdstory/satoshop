{% extends 'stores/store_base.html' %}
{% load humanize %}
{% load static %}

{% block title %}ë°°ì†¡ ì •ë³´ ì…ë ¥{% endblock %}

{% block extra_css %}
<style>
/* ì»¤ìŠ¤í…€ ê·¸ë¼ë””ì–¸íŠ¸ */
.bitcoin-gradient {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}
</style>
{% endblock %}

{% block store_content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-8">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- í—¤ë” -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center mb-4">
        <div class="p-3 bg-bitcoin/10 rounded-full mr-3">
          <i class="fas fa-shipping-fast text-3xl text-bitcoin"></i>
        </div>
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ë°°ì†¡ ì •ë³´ ì…ë ¥</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">ì£¼ë¬¸ì„ ìœ„í•œ ë°°ì†¡ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        </div>
      </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆë‚´ -->
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-6 mb-8">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-shield-alt text-yellow-600 dark:text-yellow-400 text-xl mt-1"></i>
        </div>
        <div class="ml-4">
          <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2">
            ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆë‚´
          </h3>
          <p class="text-yellow-700 dark:text-yellow-300 text-sm leading-relaxed">
            ì…ë ¥í•˜ì‹  ë°°ì†¡ ì •ë³´ëŠ” ì£¼ë¬¸ ì²˜ë¦¬ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ë©°, ì‚¬ìš©ì ê³„ì •ì—ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì£¼ë¬¸ ì™„ë£Œ í›„ ìŠ¤í† ì–´ ì£¼ì¸ì¥ì˜ ë°°ì†¡ ì‘ì—…ì„ ìœ„í•´ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    </div>

    <!-- ì£¼ë¬¸ ìš”ì•½ -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 mb-8">
      <div class="flex items-center mb-4">
        <div class="p-2 bg-bitcoin/10 rounded-lg mr-3">
          <i class="fas fa-receipt text-bitcoin"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ì£¼ë¬¸ ìš”ì•½</h3>
      </div>
      
      <div class="space-y-3">
        <div class="flex justify-between items-center text-gray-600 dark:text-gray-400">
          <span>ìƒí’ˆ ìˆ˜ëŸ‰</span>
          <span class="font-medium">{{ cart.total_items }}ê°œ</span>
        </div>
        <div class="flex justify-between items-center text-gray-600 dark:text-gray-400">
          <span>ìƒí’ˆ ê¸ˆì•¡</span>
          <span class="font-medium">{{ subtotal_amount|floatformat:0 }} sats</span>
        </div>
        <div class="flex justify-between items-center text-gray-600 dark:text-gray-400">
          <span>ë°°ì†¡ë¹„</span>
          <span class="font-medium">
            {% if total_shipping_fee == 0 %}
              <span class="text-green-600 dark:text-green-400">ë¬´ë£Œ</span>
            {% else %}
              {{ total_shipping_fee|floatformat:0 }} sats
            {% endif %}
          </span>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-600 pt-3 mt-3">
          <div class="flex justify-between items-center text-lg font-bold text-gray-900 dark:text-white">
            <span>ì´ ê²°ì œ ê¸ˆì•¡</span>
            <span class="text-bitcoin">{{ total_amount|floatformat:0 }} sats</span>
          </div>
          {% if total_amount == 0 %}
          <div class="mt-3 pt-3 border-t border-green-200 dark:border-green-600">
            <div class="flex items-center text-green-600 dark:text-green-400 text-sm">
              <i class="fas fa-gift mr-2"></i>
              <span class="font-medium">ë¬´ë£Œ ì£¼ë¬¸ì…ë‹ˆë‹¤! ë°°ì†¡ì •ë³´ ì…ë ¥ í›„ ë°”ë¡œ ì£¼ë¬¸ì´ ì™„ë£Œë©ë‹ˆë‹¤.</span>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- ë°°ì†¡ ì •ë³´ ì…ë ¥ í¼ -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-8">
      <form method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- ì£¼ë¬¸ì ì •ë³´ -->
        <div class="space-y-6">
          <div class="flex items-center pb-4 border-b border-gray-200 dark:border-gray-600">
            <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg mr-3">
              <i class="fas fa-user text-blue-600 dark:text-blue-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ì£¼ë¬¸ì ì •ë³´</h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="buyer_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                ì´ë¦„ <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                id="buyer_name" 
                name="buyer_name" 
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors" 
                value="{{ form_data.buyer_name|default:'' }}" 
                required
              >
            </div>
            
            <div>
              <label for="buyer_phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                ì—°ë½ì²˜ <span class="text-red-500">*</span>
              </label>
              <input 
                type="tel" 
                id="buyer_phone" 
                name="buyer_phone" 
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors" 
                value="{{ form_data.buyer_phone|default:'' }}" 
                placeholder="010-1234-5678" 
                required
              >
            </div>
          </div>
          
          <div>
            <label for="buyer_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              ì´ë©”ì¼ <span class="text-red-500">*</span>
            </label>
            <input 
              type="email" 
              id="buyer_email" 
              name="buyer_email" 
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors" 
              value="{% if user.is_authenticated %}{{ form_data.buyer_email|default:user.email }}{% else %}{{ form_data.buyer_email|default:'' }}{% endif %}" 
              required
            >
          </div>
        </div>

        <!-- ë°°ì†¡ì§€ ì •ë³´ -->
        <div class="space-y-6">
          <div class="flex items-center pb-4 border-b border-gray-200 dark:border-gray-600">
            <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg mr-3">
              <i class="fas fa-map-marker-alt text-green-600 dark:text-green-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ë°°ì†¡ì§€ ì •ë³´</h3>
          </div>
          
          <div class="space-y-6">
            <!-- ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ -->
            <div class="flex gap-3">
              <div class="flex-1">
                <label for="shipping_postal_code" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  ìš°í¸ë²ˆí˜¸ <span class="text-red-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="shipping_postal_code" 
                  name="shipping_postal_code" 
                  class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600" 
                  value="{{ form_data.shipping_postal_code|default:'' }}" 
                  placeholder="í´ë¦­í•˜ì—¬ ì£¼ì†Œ ê²€ìƒ‰" 
                  readonly
                  required
                >
              </div>
              <div class="flex items-end">
                <button 
                  type="button" 
                  id="address-search-btn" 
                  class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-lg whitespace-nowrap"
                >
                  <i class="fas fa-search mr-2"></i>
                  ì£¼ì†Œê²€ìƒ‰
                </button>
              </div>
            </div>
            
            <!-- ê¸°ë³¸ì£¼ì†Œ -->
            <div>
              <label for="shipping_address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                ê¸°ë³¸ì£¼ì†Œ <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                id="shipping_address" 
                name="shipping_address" 
                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600" 
                value="{{ form_data.shipping_address|default:'' }}" 
                placeholder="í´ë¦­í•˜ì—¬ ì£¼ì†Œ ê²€ìƒ‰" 
                readonly
                required
              >
            </div>
          </div>
          
          <!-- ìƒì„¸ì£¼ì†Œ -->
          <div>
            <label for="shipping_detail_address" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              ìƒì„¸ì£¼ì†Œ
            </label>
            <input 
              type="text" 
              id="shipping_detail_address" 
              name="shipping_detail_address" 
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors" 
              value="{{ form_data.shipping_detail_address|default:'' }}" 
              placeholder="ì•„íŒŒíŠ¸ëª…, ë™/í˜¸ìˆ˜ ë“± ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            >
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
              <i class="fas fa-info-circle mr-1"></i>
              ìœ„ì—ì„œ ì£¼ì†Œ ê²€ìƒ‰ í›„ ìƒì„¸ì£¼ì†Œ(ë™/í˜¸ìˆ˜, ê±´ë¬¼ëª… ë“±)ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
          </div>
        </div>

        <!-- ì£¼ë¬¸ ë©”ëª¨ -->
        <div class="space-y-6">
          <div class="flex items-center pb-4 border-b border-gray-200 dark:border-gray-600">
            <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg mr-3">
              <i class="fas fa-sticky-note text-purple-600 dark:text-purple-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ì£¼ë¬¸ ë©”ëª¨</h3>
          </div>
          
          <div>
            <label for="order_memo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              ë°°ì†¡ ìš”ì²­ì‚¬í•­
            </label>
            <textarea 
              id="order_memo" 
              name="order_memo" 
              rows="4"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-bitcoin focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors resize-vertical" 
              placeholder="ë°°ì†¡ ì‹œ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”."
            >{{ form_data.order_memo|default:'' }}</textarea>
          </div>
        </div>
         <!-- ì•¡ì…˜ ë²„íŠ¼ -->
         <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200 dark:border-gray-600">
           
           <button 
             type="submit" 
             id="checkout-btn"
             class="flex-1 inline-flex items-center justify-center px-8 py-3 bg-bitcoin hover:bg-bitcoin/90 disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors shadow-lg disabled:shadow-none"
             disabled
           >
             <i class="fas fa-credit-card mr-2" id="checkout-btn-icon"></i>
             <span id="checkout-btn-text">í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</span>
           </button>
         </div>
      </form>
    </div>
  </div>
</div>

<!-- ì£¼ì†Œê²€ìƒ‰ ëª¨ë‹¬ -->
<div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 sm:p-6">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[95vh] sm:max-h-[90vh] overflow-hidden">
    <!-- ëª¨ë‹¬ í—¤ë” -->
    <div class="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 dark:border-gray-600">
      <div class="flex items-center">
        <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg mr-3">
          <i class="fas fa-map-marker-alt text-blue-600 dark:text-blue-400"></i>
        </div>
        <h3 class="text-lg sm:text-xl font-semibold text-gray-900 dark:text-white">ì£¼ì†Œ ê²€ìƒ‰</h3>
      </div>
      <button 
        type="button" 
        id="close-address-modal" 
        class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
      >
        <i class="fas fa-times text-gray-500 dark:text-gray-400 text-xl"></i>
      </button>
    </div>
    
    <!-- ëª¨ë‹¬ ë°”ë”” -->
    <div class="p-4 sm:p-6">
      <div id="address-search-container" class="w-full h-80 sm:h-96"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Daum ìš°í¸ë²ˆí˜¸ API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- ë°ì´í„° ì „ë‹¬ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  window.shippingPageData = {
    totalAmount: {{ total_amount|default:0 }},
    subtotalAmount: {{ subtotal_amount|default:0 }},
    totalShippingFee: {{ total_shipping_fee|default:0 }}
  };
</script>
<script src="{% static 'js/shipping-info.js' %}"></script>
{% endblock %} 