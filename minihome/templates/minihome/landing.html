{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ minihome.display_name|default:minihome.slug }} | 미니홈</title>
  <link rel="icon" type="image/png" href="{% static 'images/satoshop-logo-1x1-favicon.png' %}">
  <link rel="shortcut icon" type="image/png" href="{% static 'images/satoshop-logo-1x1-favicon.png' %}">
  <link rel="apple-touch-icon" href="{% static 'images/satoshop-logo-1x1-favicon.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="{% static 'js/tailwind-config.js' %}"></script>
  <link rel="stylesheet" href="{% static 'minihome/css/landing.css' %}">
  <script>
    (function() {
      let theme = 'light';
      try {
        const stored = localStorage.getItem('theme');
        if (stored) {
          theme = stored;
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          theme = 'dark';
        }
      } catch (e) {
        theme = 'light';
      }
      document.documentElement.classList.toggle('dark', theme === 'dark');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 text-slate-100 text-sm">
  <div class="minihome-glow"></div>
  <main class="px-4 py-10">
    <div class="minihome-shell">
      <header class="text-center space-y-3">
        <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Minihome</p>
        <h1 class="text-2xl font-semibold font-display">{{ minihome.display_name|default:minihome.slug }}</h1>
        {% if is_preview %}
          <span class="inline-flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">미리보기 모드</span>
        {% endif %}
      </header>

      <div class="mt-8 space-y-6">
        {% for section in sections %}
          {% if section.type == 'brand_image' %}
            <section class="minihome-section-card">
              {% if section.data.image.url %}
                <img src="{{ section.data.image.url }}" alt="브랜드 이미지" class="w-full rounded-3xl shadow-lg">
              {% else %}
                <div class="minihome-empty">브랜드 이미지를 등록해주세요.</div>
              {% endif %}
            </section>
          {% endif %}

          {% if section.type == 'title' %}
            <section class="minihome-section-card text-center space-y-3">
              <h2 class="text-xl font-semibold">{{ section.data.title|default:'브랜드 타이틀' }}</h2>
              <p class="text-slate-300 whitespace-pre-line">{{ section.data.description|default:'' }}</p>
            </section>
          {% endif %}

          {% if section.type == 'gallery' %}
            <section class="minihome-section-card space-y-5">
              {% for item in section.data.items %}
                <div class="flex flex-col gap-4 {% if forloop.counter0|divisibleby:2 %}sm:flex-row{% else %}sm:flex-row-reverse{% endif %}">
                  <div class="sm:w-1/2">
                    {% if item.image.url %}
                      <img src="{{ item.image.url }}" alt="갤러리 이미지" class="rounded-2xl w-full h-48 object-cover">
                    {% else %}
                      <div class="minihome-empty h-48">이미지를 추가해주세요.</div>
                    {% endif %}
                  </div>
                  <div class="sm:w-1/2 flex items-center">
                    <p class="text-slate-200 whitespace-pre-line">{{ item.description|default:'' }}</p>
                  </div>
                </div>
              {% empty %}
                <div class="minihome-empty">갤러리 아이템이 없습니다.</div>
              {% endfor %}
              {% if can_manage %}
                <div class="minihome-owner-tools">
                  <button type="button" class="minihome-link" data-toggle-form="gallery-form-{{ section.id }}">갤러리 아이템 추가</button>
                  <form id="gallery-form-{{ section.id }}" class="minihome-inline-form hidden" method="post" enctype="multipart/form-data" action="{% url 'minihome:add_gallery_item' slug=minihome.slug %}">
                    {% csrf_token %}
                    <input type="hidden" name="section_id" value="{{ section.id }}">
                    <label class="minihome-field">
                      <span>설명 (최대 100자)</span>
                      <textarea name="description" rows="3" maxlength="100"></textarea>
                    </label>
                    <label class="minihome-field">
                      <span>이미지 업로드</span>
                      <input type="file" name="image" accept="image/*">
                    </label>
                    <div class="flex justify-end">
                      <button type="submit" class="minihome-link">저장</button>
                    </div>
                  </form>
                </div>
              {% endif %}
            </section>
          {% endif %}

          {% if section.type == 'mini_blog' %}
            <section class="minihome-section-card">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">미니 블로그</h3>
                <span class="text-xs text-slate-300">클릭해서 자세히 보기</span>
              </div>
              {% if can_manage %}
                <div class="minihome-owner-tools">
                  <button type="button" class="minihome-link" data-toggle-form="blog-form-{{ section.id }}">글쓰기</button>
                  <form id="blog-form-{{ section.id }}" class="minihome-inline-form hidden" method="post" enctype="multipart/form-data" action="{% url 'minihome:add_blog_post' slug=minihome.slug %}">
                    {% csrf_token %}
                    <input type="hidden" name="section_id" value="{{ section.id }}">
                    <label class="minihome-field">
                      <span>내용</span>
                      <textarea name="text" rows="6" maxlength="1000"></textarea>
                    </label>
                    <div class="grid gap-3 md:grid-cols-2">
                      <label class="minihome-field">
                        <span>이미지 1</span>
                        <input type="file" name="image_0" accept="image/*">
                      </label>
                      <label class="minihome-field">
                        <span>이미지 2</span>
                        <input type="file" name="image_1" accept="image/*">
                      </label>
                      <label class="minihome-field">
                        <span>이미지 3</span>
                        <input type="file" name="image_2" accept="image/*">
                      </label>
                      <label class="minihome-field">
                        <span>이미지 4</span>
                        <input type="file" name="image_3" accept="image/*">
                      </label>
                    </div>
                    <div class="flex justify-end">
                      <button type="submit" class="minihome-link">저장</button>
                    </div>
                  </form>
                </div>
              {% endif %}
              <div class="mt-4 grid gap-3 md:grid-cols-2" data-blog-list>
                {% for post in section.data.posts %}
                  <button type="button" class="minihome-blog-card" data-blog-card data-text="{{ post.text|escape }}"
                    data-image0="{{ post.images.0.url|default:'' }}" data-image1="{{ post.images.1.url|default:'' }}"
                    data-image2="{{ post.images.2.url|default:'' }}" data-image3="{{ post.images.3.url|default:'' }}">
                    <div class="flex items-start gap-3">
                      <div class="flex-1 text-left">
                        <p class="line-clamp-3 text-slate-200">{{ post.text|default:'' }}</p>
                      </div>
                      {% if post.images.0.url %}
                        <img src="{{ post.images.0.url }}" alt="썸네일" class="h-16 w-16 rounded-xl object-cover">
                      {% endif %}
                    </div>
                  </button>
                {% empty %}
                  <div class="minihome-empty">등록된 글이 없습니다.</div>
                {% endfor %}
              </div>
              <div class="minihome-pagination hidden" data-blog-pagination>
                <button type="button" class="minihome-pagination-btn" data-page-prev>이전</button>
                <span class="minihome-pagination-text" data-page-indicator>1 / 1</span>
                <button type="button" class="minihome-pagination-btn" data-page-next>다음</button>
              </div>
            </section>
          {% endif %}

          {% if section.type == 'map' %}
            <section class="minihome-section-card space-y-3">
              <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold">{{ section.data.title|default:'지도' }}</h3>
                {% if section.data.address %}
                  <span class="text-xs text-slate-300">{{ section.data.address }}</span>
                {% endif %}
              </div>
              {% if naver_maps_client_id %}
                <div class="minihome-map" data-map data-lat="{{ section.data.lat|default_if_none:'' }}" data-lng="{{ section.data.lng|default_if_none:'' }}" data-title="{{ section.data.title|default:'' }}"></div>
              {% else %}
                <div class="minihome-empty">네이버 지도 API 키가 설정되지 않았습니다.</div>
              {% endif %}
            </section>
          {% endif %}

          {% if section.type == 'store' %}
            <section class="minihome-section-card space-y-3">
              <h3 class="text-sm font-semibold">매장</h3>
              <div class="space-y-3">
                {% for store in section.data.stores %}
                  <div class="flex items-center justify-between gap-3 p-3 rounded-2xl border border-slate-700 bg-slate-900/60">
                    <div>
                      <p class="font-semibold">{{ store.name|default:'매장' }}</p>
                      <p class="text-xs text-slate-300">{{ store.map_url|default:'' }}</p>
                    </div>
                    {% if store.map_url %}
                      <a class="minihome-link" href="{{ store.map_url }}" target="_blank" rel="noopener">지도 열기</a>
                    {% endif %}
                  </div>
                {% empty %}
                  <div class="minihome-empty">등록된 매장이 없습니다.</div>
                {% endfor %}
              </div>
            </section>
          {% endif %}

          {% if section.type == 'cta' %}
            <section class="minihome-section-card space-y-4">
              <div class="flex items-center gap-4">
                {% if section.data.profile_image.url %}
                  <img src="{{ section.data.profile_image.url }}" alt="프로필" class="h-16 w-16 rounded-2xl object-cover">
                {% else %}
                  <div class="h-16 w-16 rounded-2xl bg-slate-800"></div>
                {% endif %}
                <div>
                  <h3 class="text-sm font-semibold">함께하기</h3>
                  <p class="text-xs text-slate-300">연락 또는 후원 정보를 확인하세요.</p>
                </div>
              </div>
              <p class="text-slate-200 whitespace-pre-line">{{ section.data.description|default:'' }}</p>
              <div class="grid gap-2">
                {% if section.data.email %}
                  <a class="minihome-link" href="mailto:{{ section.data.email }}">{{ section.data.email }}</a>
                {% endif %}
                {% if section.data.donation %}
                  <span class="minihome-chip">후원 주소: {{ section.data.donation }}</span>
                {% endif %}
              </div>
            </section>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </main>

  <div class="minihome-modal hidden" data-blog-modal>
    <div class="minihome-modal-panel">
      <div class="flex items-center justify-between">
        <h4 class="text-sm font-semibold">미니 블로그</h4>
        <button type="button" class="minihome-icon-btn" data-modal-close>닫기</button>
      </div>
      <p class="mt-3 text-slate-200 whitespace-pre-line" data-modal-text></p>
      <div class="mt-4 grid grid-cols-2 gap-3" data-modal-images></div>
    </div>
  </div>

  {% if has_map_section and naver_maps_client_id %}
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId={{ naver_maps_client_id }}"></script>
  {% endif %}
  <script src="{% static 'minihome/js/landing.js' %}"></script>
</body>
</html>
